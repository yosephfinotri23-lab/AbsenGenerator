<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Absen Generator RSUPP Betun</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      :root {
        /* -- Light Theme Variables -- */
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #64748b;
        --bg-body: #f1f5f9;
        --bg-panel: #ffffff;
        --border: #e2e8f0;
        --text-main: #334155;
        --text-muted: #64748b;
        --input-bg: #ffffff;
        --input-border: #cbd5e1;
        --danger: #ef4444;
        --danger-bg: #fef2f2;
        --danger-border: #fee2e2;
        --success: #10b981;
        --warning: #f59e0b;
        --paper-width: 297mm;
        --table-header-bg: transparent;
        --card-bg: #f8fafc;
        
        /* Layout Dimensions */
        --sidebar-icon-width: 80px;
        --sidebar-content-width: 320px;
        --sidebar-total-width: calc(var(--sidebar-icon-width) + var(--sidebar-content-width));
      }

      /* -- Dark Theme Variables -- */
      body.dark-mode {
        --primary: #818cf8;
        --primary-dark: #6366f1;
        --secondary: #94a3b8;
        --bg-body: #0f172a;
        --bg-panel: #1e293b;
        --border: #334155;
        --text-main: #f1f5f9;
        --text-muted: #cbd5e1;
        --input-bg: #0f172a;
        --input-border: #475569;
        --card-bg: #0f172a;
        --danger-bg: #450a0a;
        --danger-border: #7f1d1d;
      }

      * {
        box-sizing: border-box;
        outline: none;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        transition: background-color 0.3s, color 0.3s;
      }

      /* --- Sidebar Container Wrapper --- */
      .sidebar-wrapper {
        display: flex;
        flex-direction: column; /* Stack Header and Body vertically */
        width: var(--sidebar-total-width);
        height: 100vh;
        background: var(--bg-panel);
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.03);
        z-index: 20;
        flex-shrink: 0;
        border-right: 1px solid var(--border);
        transition: width 0.3s ease;
      }

      /* --- 1. Top Brand Header (Full Width) --- */
      .brand-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 20px;
        border-bottom: 1px solid var(--border);
        background: var(--bg-panel);
        height: 80px; /* Fixed height for header */
        flex-shrink: 0;
      }

      .brand-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .brand-icon {
        background: #e0e7ff;
        color: #4f46e5;
        width: 44px;
        height: 44px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        flex-shrink: 0;
      }
      body.dark-mode .brand-icon {
        background: #312e81;
        color: #a5b4fc;
      }

      .brand-text {
        display: flex;
        flex-direction: column;
        line-height: 1.2;
      }
      .brand-title {
        font-size: 1rem;
        font-weight: 800;
        color: var(--primary);
        letter-spacing: -0.3px;
        white-space: nowrap;
      }
      .brand-subtitle {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        white-space: nowrap;
      }

      .theme-toggle {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--secondary);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
      }
      .theme-toggle:hover {
        background: var(--bg-body);
        color: var(--primary);
        transform: rotate(15deg);
      }

      /* --- 2. Sidebar Body (Icons + Content) --- */
      .sidebar-body {
        display: flex;
        flex: 1;
        overflow: hidden; /* Prevent double scrollbars */
      }

      /* Left Icon Bar */
      .icon-bar {
        width: var(--sidebar-icon-width);
        background: var(--bg-panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        overflow-y: auto;
        /* Hide scrollbar standard */
        scrollbar-width: none;  /* Firefox */
        -ms-overflow-style: none;  /* IE/Edge */
      }
      /* Hide scrollbar Webkit */
      .icon-bar::-webkit-scrollbar {
        display: none;
      }

      .tab-btn {
        width: 48px;
        height: 48px;
        margin-bottom: 12px;
        border: 1px solid transparent;
        border-radius: 12px; 
        background: transparent;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        position: relative;
        flex-shrink: 0;
      }

      .tab-btn i {
        font-size: 1.25rem;
      }

      .tab-btn:hover {
        color: var(--primary);
        background: var(--bg-body);
        transform: translateY(-2px);
      }
      
      /* Tooltip */
      .tab-btn:hover::after {
        content: attr(title);
        position: absolute;
        left: 55px;
        background: var(--text-main);
        color: var(--bg-panel);
        padding: 5px 10px;
        border-radius: 4px;
        white-space: nowrap;
        font-size: 0.75rem;
        pointer-events: none;
        z-index: 100;
        opacity: 0.9;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
      }
      
      .tab-btn.active {
        color: var(--primary);
        background: #e0e7ff;
        border-color: #c7d2fe;
        box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);
      }
      body.dark-mode .tab-btn.active {
        background: rgba(99, 102, 241, 0.15);
        border-color: rgba(99, 102, 241, 0.3);
      }
      
      .tab-btn::after {
        display: none; 
      }
      .tab-btn:hover::after {
        display: block; 
      }

      /* Right Input Content */
      .input-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--bg-panel);
      }
      .input-content::-webkit-scrollbar {
        width: 6px;
      }
      .input-content::-webkit-scrollbar-thumb {
        background-color: var(--border);
        border-radius: 3px;
      }

      .tab-panel {
        display: none;
        animation: fadeIn 0.3s ease-out;
      }
      .tab-panel.active {
        display: block;
      }

      /* Panel Title Header */
      .panel-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--text-main);
        margin-top: 0;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: -0.3px;
      }
      .panel-title i {
        color: var(--primary);
        font-size: 1.2rem;
      }

      /* --- Form Elements --- */
      .form-group { margin-bottom: 18px; }
      .form-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 8px;
        letter-spacing: 0.5px;
      }
      input[type="text"], input[type="number"], input[type="tel"], select, textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--input-border);
        border-radius: 8px;
        font-size: 0.9rem;
        transition: all 0.2s;
        background: var(--input-bg);
        color: var(--text-main);
      }
      input:focus, textarea:focus, select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        outline: none;
      }
      textarea { resize: vertical; min-height: 100px; font-family: monospace; line-height: 1.4; }
      .card-options { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
      .row-inputs { display: flex; gap: 10px; }

      /* Buttons */
      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        font-size: 0.9rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .btn:active { transform: translateY(1px); }
      .btn-primary { background: var(--primary); color: white; }
      .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.3); }
      .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); margin-top: 10px; }
      .btn-outline:hover { background: var(--bg-body); border-color: var(--secondary); }
      .btn-danger { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger-border); }
      .btn-danger:hover { background: #fee2e2; }
      body.dark-mode .btn-danger:hover { background: #7f1d1d; }
      .btn-success { background: #d1fae5; color: #059669; border: 1px solid #a7f3d0; margin-top: 10px; }
      .btn-success:hover { background: #a7f3d0; }
      body.dark-mode .btn-success { background: #064e3b; color: #a7f3d0; border-color: #065f46; }
      .btn-warning { background: #fef3c7; color: #b45309; border: 1px solid #fde68a; margin-top: 10px; }
      .btn-warning:hover { background: #fde68a; }
      body.dark-mode .btn-warning { background: #78350f; color: #fde68a; border-color: #92400e; }
      .btn-small { padding: 6px 12px; font-size: 0.8rem; width: auto; display: inline-flex; }

      /* Special Sections */
      .danger-zone { margin-top: 30px; border: 1px solid var(--danger); border-radius: 8px; padding: 15px; background: var(--danger-bg); }
      .danger-title { color: var(--danger); font-weight: 800; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 0.8rem; text-transform: uppercase; }
      .danger-desc { font-size: 0.8rem; color: var(--danger); margin-bottom: 12px; opacity: 0.8; }
      .wa-steps { font-size: 0.85rem; margin-bottom: 15px; background: var(--bg-body); padding: 10px; border-radius: 8px; }
      .wa-step-item { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-start; }
      .step-num { background: var(--primary); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; flex-shrink: 0; margin-top: 2px; }

      /* --- Main Preview Area --- */
      .main-area {
        flex: 1;
        overflow: auto;
        padding: 40px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        position: relative;
        background-color: var(--bg-body);
        transition: background-color 0.3s;
      }
      .paper {
        background: white;
        width: var(--paper-width);
        min-width: var(--paper-width);
        min-height: 210mm;
        padding: 15mm 10mm;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
        border-radius: 2px;
        position: relative;
        color: #000000;
      }
      body.dark-mode .paper { box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); }
      
      /* Paper Content - UPDATED FOR TABLE SIZE */
      .header-section { display: flex; align-items: center; justify-content: center; gap: 20px; border-bottom: 3px double #000; padding-bottom: 15px; margin-bottom: 20px; }
      .logo-img { height: 80px; width: 80px; object-fit: contain; }
      .header-text { text-align: center; color: #000; }
      .header-text h1 { margin: 0; font-size: 18pt; text-transform: uppercase; letter-spacing: 1px; }
      .header-text h3 { margin: 5px 0 0 0; font-size: 12pt; font-weight: normal; text-transform: uppercase; }
      
      table { width: 100%; border-collapse: collapse; font-size: 11pt; border: 2px solid #000; table-layout: fixed; } /* Font increased */
      th, td { border: 1px solid #000; padding: 6px 4px; text-align: center; vertical-align: middle; color: #000; background-color: transparent; } /* Padding increased */
      thead th { background-color: var(--table-header-bg, transparent); height: 35px; font-weight: bold; }
      .col-no { width: 30px; }
      .col-nama { width: 220px; text-align: left; padding-left: 8px; font-weight: 700; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-right: 2px solid #000; cursor: pointer; }
      .col-nama:hover { background-color: #f1f5f9; color: var(--primary); text-decoration: underline; }
      .col-ket { width: 60px; font-size: 9pt; font-style: italic; background: #fafafa; border-right: 2px solid #000; text-align: right; padding-right: 5px; } /* Ket slightly larger */
      .cell-input { cursor: pointer; font-family: "Courier New", monospace; font-weight: bold; font-size: 11pt; transition: background 0.1s; user-select: none; } /* Font increased */
      .cell-input:hover { background-color: #e0e7ff !important; }
      .status-P { color: #000000 !important; font-weight: bold; }
      .status-S { color: #b45309 !important; font-weight: bold; }
      .status-M { color: #16a34a !important; font-weight: bold; }
      .status-L { color: #dc2626 !important; font-weight: bold; }
      .status-A { color: #dc2626 !important; font-weight: bold; }
      .status-I { color: #000000 !important; font-weight: bold; }
      .st-libur { background-color: #fee2e2 !important; color: #991b1b; }
      
      .signature-row td { border: none !important; padding-top: 30px; background-color: white !important; page-break-inside: avoid; } /* Smart TTD Break */
      .footer-ttd { display: flex; justify-content: space-between; width: 100%; padding: 0 20px; page-break-inside: avoid; }
      .ttd-block { text-align: left; min-width: 220px; }
      .ttd-space { height: 80px; }
      .ttd-block p { margin: 5px 0; }

      /* Modal */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
      .modal-box { background: var(--bg-panel); color: var(--text-main); width: 600px; max-height: 80vh; border-radius: 12px; padding: 24px; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
      .modal-header { font-size: 1.25rem; font-weight: bold; margin-bottom: 20px; display: flex; justify-content: space-between; color: var(--primary); }
      .modal-content { overflow-y: auto; flex: 1; }
      .stat-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; border: none; }
      .stat-table th, .stat-table td { border: 1px solid var(--border); padding: 10px; text-align: center; }
      .stat-table th { background: var(--bg-body); text-align: left; font-weight: 600; }
      .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary); }

      /* Responsive */
      @media (max-width: 1024px) {
        body { flex-direction: column; height: auto; overflow-y: auto; }
        .sidebar-wrapper { width: 100%; height: auto; border-right: none; border-bottom: 1px solid var(--border); }
        .brand-header { padding: 10px 15px; }
        .sidebar-body { flex-direction: column; }
        .icon-bar { width: 100%; flex-direction: row; border-right: none; border-bottom: 1px solid var(--border); padding: 10px; gap: 10px; overflow-x: auto; }
        .tab-btn { margin-bottom: 0; }
        .input-content { padding: 15px; max-height: 50vh; }
        .main-area { padding: 20px 10px; display: block; width: 100%; overflow: auto; }
        .paper { margin: 0 auto; margin-bottom: 20px; transform: scale(0.8); transform-origin: top center; }
      }
      @media (max-width: 600px) {
        .paper { transform: scale(0.5); width: 297mm; }
        .header-text h1 { font-size: 14pt; }
        .header-text h3 { font-size: 10pt; }
        .brand-title { font-size: 0.9rem; }
        .brand-subtitle { font-size: 0.7rem; }
      }

      @media print {
        body { background: white; height: auto; overflow: visible; display: block; }
        .sidebar-wrapper, .modal-overlay { display: none !important; }
        .main-area { padding: 0; margin: 0; display: block; overflow: visible; width: 100%; height: auto; }
        .paper { box-shadow: none; margin: 0; width: 100% !important; padding: 0; border: none; transform: none !important; }
        .table-wrapper { overflow-x: auto; width: 100%; page-break-before: avoid; }
        table { font-size: 11pt; page-break-inside: avoid; } /* Font size updated */
        thead { display: table-header-group; }
        tbody { display: table-row-group; page-break-inside: auto; }
        tr { page-break-inside: avoid; }
        th, td { padding: 4px !important; height: auto !important; } /* Padding increased */
        thead th { height: 28px !important; }
        .header-section { margin-bottom: 10px; padding-bottom: 5px; page-break-after: avoid; }
        .header-text h1 { margin: 0; font-size: 14pt; }
        .header-text h3 { margin: 0; font-size: 10pt; }
        .signature-row td { padding-top: 10px !important; page-break-inside: avoid; }
        .ttd-space { height: 50px !important; }
        .ttd-block p { margin: 2px 0 !important; line-height: 1.2; }
        .footer-ttd { page-break-inside: avoid; break-inside: avoid; }
        @page { size: landscape; margin: 5mm; }
        * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
  </head>
  <body>
    <!-- Sidebar Wrapper -->
    <div class="sidebar-wrapper">
        
        <!-- 1. Header Sidebar (Melebar Kekanan) -->
        <div class="brand-header">
            <div class="brand-info">
                <div class="brand-icon">
                  <i class="fa-solid fa-hospital"></i>
                </div>
                <div class="brand-text">
                  <span class="brand-title">Absen Generator</span>
                  <span class="brand-subtitle">RSUPP Betun</span>
                </div>
            </div>
            
            <!-- Tombol Toggle Dark Mode -->
            <button
              class="theme-toggle"
              onclick="App.toggleTheme()"
              title="Ubah Tema Gelap/Terang"
            >
              <i class="fa-solid fa-moon" id="themeIcon"></i>
            </button>
        </div>

        <!-- 2. Body Sidebar (Ikon + Konten Input) -->
        <div class="sidebar-body">
            <aside class="icon-bar">
                <button
                  id="btn-tab-umum"
                  class="tab-btn active"
                  onclick="App.switchTab('tab-umum')"
                  title="Umum"
                >
                  <i class="fa-solid fa-house"></i>
                </button>
                <button
                  id="btn-tab-pegawai"
                  class="tab-btn"
                  onclick="App.switchTab('tab-pegawai')"
                  title="Pegawai"
                >
                  <i class="fa-solid fa-users"></i>
                </button>
                <button
                  id="btn-tab-ttd"
                  class="tab-btn"
                  onclick="App.switchTab('tab-ttd')"
                  title="Tanda Tangan"
                >
                  <i class="fa-solid fa-signature"></i>
                </button>
                <button
                  id="btn-tab-setting"
                  class="tab-btn"
                  onclick="App.switchTab('tab-setting')"
                  title="Setting"
                >
                  <i class="fa-solid fa-gear"></i>
                </button>
                <button
                  id="btn-tab-data"
                  class="tab-btn"
                  onclick="App.switchTab('tab-data')"
                  title="Data & Output"
                >
                  <i class="fa-solid fa-database"></i>
                </button>
            </aside>

            <div class="input-content">
                <!-- TAB UMUM -->
                <div id="tab-umum" class="tab-panel active">
                  <div class="panel-title">
                    <i class="fa-solid fa-house"></i> Umum
                  </div>
                  <div class="form-group">
                    <label>Judul Laporan</label>
                    <input
                      type="text"
                      id="judulLaporan"
                      value="DAFTAR HADIR PEGAWAI"
                      oninput="App.render()"
                    />
                  </div>
                  <div class="form-group">
                    <label>Periode Absensi</label>
                    <div class="row-inputs">
                      <select id="bulan" onchange="App.render()"></select>
                      <input
                        type="number"
                        id="tahun"
                        style="width: 80px"
                        onchange="App.render()"
                      />
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Hari Libur</label>
                    <div class="card-options">
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          margin-bottom: 8px;
                        "
                      >
                        <input
                          type="checkbox"
                          id="sabtuLibur"
                          style="width: auto"
                          onchange="App.render()"
                        />
                        <span style="font-size: 0.9rem; font-weight: 600"
                          >Sabtu Merah</span
                        >
                      </div>
                      <input
                        type="text"
                        id="libur"
                        placeholder="Tgl Merah Manual (Cth: 1, 17)"
                        oninput="App.render()"
                      />
                    </div>
                  </div>
                </div>

                <!-- TAB SETTING -->
                <div id="tab-setting" class="tab-panel">
                  <div class="panel-title">
                    <i class="fa-solid fa-gear"></i> Setting
                  </div>
                  <div class="form-group">
                    <label>Opsi Tampilan Baris</label>
                    <div class="card-options">
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          margin-bottom: 5px;
                        "
                      >
                        <input
                          type="checkbox"
                          id="toggleShift"
                          style="width: auto"
                          onchange="App.render()"
                          checked
                        />
                        <span style="font-size: 0.9rem">Baris Shift</span>
                      </div>
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          margin-bottom: 5px;
                        "
                      >
                        <input
                          type="checkbox"
                          id="toggleDatang"
                          style="width: auto"
                          onchange="App.render()"
                          checked
                        />
                        <span style="font-size: 0.9rem">Baris Jam Datang</span>
                      </div>
                      <div
                        style="
                          display: flex;
                          align-items: center;
                          gap: 8px;
                          margin-bottom: 5px;
                        "
                      >
                        <input
                          type="checkbox"
                          id="togglePulang"
                          style="width: auto"
                          onchange="App.render()"
                          checked
                        />
                        <span style="font-size: 0.9rem">Baris Jam Pulang</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px">
                        <input
                          type="checkbox"
                          id="toggleParaf"
                          style="width: auto"
                          onchange="App.render()"
                          checked
                        />
                        <span style="font-size: 0.9rem">Baris Paraf</span>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Mode Daftar Hadir</label>
                    <div
                      class="card-options"
                      style="display: flex; align-items: center; gap: 8px"
                    >
                      <input
                        type="checkbox"
                        id="modeTim"
                        style="width: auto; margin: 0"
                        onchange="App.render()"
                      />
                      <span style="font-size: 0.9rem; font-weight: 600"
                        >Aktifkan Mode Tim</span
                      >
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Personalisasi Tampilan</label>
                    <div class="row-inputs">
                      <input
                        type="color"
                        id="headerColor"
                        value="#ffffff"
                        style="height: 42px; padding: 2px; cursor: pointer; flex: 1"
                        oninput="App.updateColor()"
                      />
                      <button
                        class="btn btn-outline btn-small"
                        onclick="document.getElementById('logoFile').click()"
                      >
                        Ganti Logo
                      </button>
                    </div>
                    <input
                      type="text"
                      id="logoUrl"
                      placeholder="Atau paste URL Logo..."
                      oninput="App.render()"
                      style="margin-top: 10px"
                    />
                    <input
                      type="file"
                      id="logoFile"
                      accept="image/*"
                      style="display: none"
                      onchange="App.handleLogoUpload(this)"
                    />
                  </div>
                </div>

                <!-- TAB PEGAWAI -->
                <div id="tab-pegawai" class="tab-panel">
                  <div class="panel-title">
                    <i class="fa-solid fa-users"></i> Pegawai
                  </div>
                  <div
                    class="form-group"
                    style="
                      background: rgba(99, 102, 241, 0.1);
                      padding: 15px;
                      border-radius: 8px;
                      border: 1px solid var(--primary);
                    "
                  >
                    <label style="color: var(--primary)">Tambah Pegawai Baru</label>
                    <input type="text" id="newNama" placeholder="Nama Lengkap" />
                    <select id="newTim" style="margin-top: 8px">
                      <option value="">-- Pilih Tim (Opsional) --</option>
                      <option value="Tim 1">Tim 1</option>
                      <option value="Tim 2">Tim 2</option>
                      <option value="Tim 3">Tim 3</option>
                      <option value="Tim 4">Tim 4</option>
                      <option value="Tim 5">Tim 5</option>
                      <option value="Tim 6">Tim 6</option>
                      <option value="Tim 7">Tim 7</option>
                      <option value="Tim 8">Tim 8</option>
                      <option value="Tim 9">Tim 9</option>
                      <option value="Tim 10">Tim 10</option>
                    </select>
                    <button
                      class="btn btn-primary"
                      style="margin-top: 10px"
                      onclick="App.tambahPegawai()"
                    >
                      <i class="fa fa-plus"></i> Tambahkan
                    </button>
                  </div>
                  <div class="form-group">
                    <label>Edit Daftar Nama (Massal)</label>
                    <textarea
                      id="listNama"
                      style="height: 300px; font-size: 0.85rem"
                      placeholder="Format: [Tim] Nama"
                      onblur="App.render()"
                    >
[Tim 1] Dr. Budi Santoso
[Tim 1] Suster Siti Aminah
[Tim 2] Perawat Joko
Admin Rina</textarea
                    >
                    <small
                      style="
                        color: var(--text-muted);
                        font-size: 0.75rem;
                        display: block;
                        margin-top: 5px;
                      "
                      >*Klik nama di tabel preview untuk menghapus baris pegawai.</small
                    >
                  </div>

                   <div class="form-group">
                    <label>Rekapitulasi Absensi</label>
                    <div class="row-inputs">
                        <button class="btn btn-warning" onclick="App.showStats('shift')">
                            <i class="fa-solid fa-clock"></i> Rekap Shift
                        </button>
                        <button class="btn btn-warning" onclick="App.showStats('status')">
                            <i class="fa-solid fa-user-check"></i> Rekap Status
                        </button>
                    </div>
                </div>
                </div>

                <!-- TAB TTD -->
                <div id="tab-ttd" class="tab-panel">
                  <div class="panel-title">
                    <i class="fa-solid fa-signature"></i> Tanda Tangan
                  </div>
                  <div class="form-group">
                    <label>Kiri (Mengetahui)</label>
                    <input
                      type="text"
                      id="ttd1_jabatan"
                      placeholder="Jabatan (mis: Direktur)"
                      class="mb-1"
                      oninput="App.render()"
                    />
                    <input
                      type="text"
                      id="ttd1_nama"
                      placeholder="Nama Pejabat"
                      style="margin-top: 5px"
                      oninput="App.render()"
                    />
                    <input
                      type="text"
                      id="ttd1_nip"
                      placeholder="NIP"
                      style="margin-top: 5px"
                      oninput="App.render()"
                    />
                  </div>
                  <hr style="border-top: 1px dashed var(--border); margin: 15px 0" />
                  <div class="form-group">
                    <label>Kanan (Pembuat/Ka. Ruang)</label>
                    <input
                      type="text"
                      id="ttd2_jabatan"
                      placeholder="Jabatan"
                      oninput="App.render()"
                    />
                    <input
                      type="text"
                      id="ttd2_kota"
                      placeholder="Kota (mis: Jakarta)"
                      style="margin-top: 5px"
                      oninput="App.render()"
                    />
                    <input
                      type="text"
                      id="ttd2_nama"
                      placeholder="Nama Pegawai"
                      style="margin-top: 5px"
                      oninput="App.render()"
                    />
                    <input
                      type="text"
                      id="ttd2_nip"
                      placeholder="NIP"
                      style="margin-top: 5px"
                      oninput="App.render()"
                    />
                  </div>
                </div>

                <!-- TAB DATA & OUTPUT -->
                <div id="tab-data" class="tab-panel">
                    <div class="panel-title">
                        <i class="fa-solid fa-database"></i> Data & Output
                    </div>
                    <div class="form-group">
                        <label>1. Cetak / PDF</label>
                        <button class="btn btn-primary" onclick="App.previewPDF()">
                            <i class="fa-solid fa-eye"></i> Preview (Tab Baru)
                        </button>
                        <button class="btn btn-primary" style="margin-top:10px;" onclick="window.print()">
                            <i class="fa-solid fa-print"></i> Download PDF (Print)
                        </button>
                    </div>

                    <div class="form-group">
                        <label>2. Backup Data</label>
                        <button class="btn btn-outline" onclick="App.backupData()">
                            <i class="fa-solid fa-download"></i> Backup Data (.json)
                        </button>
                        <button class="btn btn-outline" onclick="document.getElementById('fileRestore').click()" style="margin-top:10px;">
                            <i class="fa-solid fa-upload"></i> Restore
                        </button>
                        <input
                          type="file"
                          id="fileRestore"
                          accept=".json"
                          style="display: none"
                          onchange="App.restoreData(this)"
                        />
                    </div>

                    <hr style="border-top: 1px dashed var(--border); margin: 24px 0" />

                    <div class="form-group">
                        <label>3. Kirim Laporan via WA</label>
                        <div class="card-options">
                            <div class="wa-steps">
                                <div class="wa-step-item">
                                    <span class="step-num">1</span>
                                    <span>Pastikan sudah download <b>File PDF</b> dan <b>File Backup (.json)</b>.</span>
                                </div>
                                <div class="wa-step-item">
                                    <span class="step-num">2</span>
                                    <span>Klik tombol di bawah untuk membuka WhatsApp.</span>
                                </div>
                                <div class="wa-step-item">
                                    <span class="step-num">3</span>
                                    <span>Pilih kontak tujuan, lalu lampirkan kedua file tersebut.</span>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="App.sendWA()">
                                <i class="fa-brands fa-whatsapp"></i> Buka WhatsApp & Kirim
                            </button>
                            <small style="display:block; margin-top:5px; font-size:0.75rem; color:var(--text-muted);">
                                *Chat otomatis akan terisi. Anda tinggal memilih kontak dan melampirkan file.
                            </small>
                        </div>
                    </div>

                     <div class="danger-zone">
                        <div class="danger-title">
                            <i class="fa-solid fa-triangle-exclamation"></i> DAERAH BERBAHAYA
                        </div>
                        <div class="danger-desc">
                            Menghapus seluruh data yang tersimpan di browser ini. Tindakan ini tidak dapat dibatalkan.
                        </div>
                        <button class="btn btn-danger" onclick="App.resetData()">
                            <i class="fa-solid fa-trash"></i> Reset Semua Data
                        </button>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <main class="main-area">
      <div class="paper">
        <div class="header-section">
          <img id="viewLogo" src="" class="logo-img" />
          <div class="header-text">
            <h1 id="viewJudulInstansi">
              RUMAH SAKIT UMUM PENYANGGA PERBATASAN BETUN
            </h1>
            <h3 id="viewSubJudul"></h3>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="mainTable"></table>
        </div>
        <div id="signatureSection"></div>
      </div>
    </main>

    <div id="statsModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">
          <span id="statsTitle">Rekapitulasi Absensi</span>
          <button
            class="close-btn"
            onclick="document.getElementById('statsModal').style.display='none'"
          >
            &times;
          </button>
        </div>
        <div class="modal-content">
          <table class="stat-table" id="statTableContent"></table>
        </div>
        <button
          class="btn btn-primary"
          style="margin-top: 15px"
          onclick="document.getElementById('statsModal').style.display='none'"
        >
          Tutup
        </button>
      </div>
    </div>

    <script>
      const App = {
        data: { attendance: {} },
        months: [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ],
        timMap: {},

        init() {
          const sel = document.getElementById("bulan");
          this.months.forEach((m, i) => sel.add(new Option(m, i)));
          const now = new Date();
          sel.value = now.getMonth();
          document.getElementById("tahun").value = now.getFullYear();

          // Load Theme Preference
          const savedTheme = localStorage.getItem("absenProTheme");
          if (savedTheme === "dark") {
            document.body.classList.add("dark-mode");
            document.getElementById("themeIcon").className = "fa-solid fa-sun";
          }

          this.loadState();
          this.render();
        },

        toggleTheme() {
          document.body.classList.toggle("dark-mode");
          const isDark = document.body.classList.contains("dark-mode");
          localStorage.setItem("absenProTheme", isDark ? "dark" : "light");
          document.getElementById("themeIcon").className = isDark
            ? "fa-solid fa-sun"
            : "fa-solid fa-moon";
        },

        switchTab(tabId) {
          document
            .querySelectorAll(".tab-panel")
            .forEach((el) => el.classList.remove("active"));
          document
            .querySelectorAll(".tab-btn")
            .forEach((el) => el.classList.remove("active"));
          document.getElementById(tabId).classList.add("active");
          document.getElementById("btn-" + tabId).classList.add("active");
        },

        handleLogoUpload(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById("logoUrl").value = e.target.result;
              this.render();
            };
            reader.readAsDataURL(input.files[0]);
          }
        },

        updateColor() {
          const c = document.getElementById("headerColor").value;
          document.documentElement.style.setProperty("--table-header-bg", c);
          this.saveState();
        },

        getDaysArray() {
          const mIdx = parseInt(document.getElementById("bulan").value);
          const year = parseInt(document.getElementById("tahun").value);
          const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
          const liburVal = document.getElementById("libur").value || "";
          const manualHolidays = liburVal
            .split(",")
            .map((n) => parseInt(n.trim()));
          const sabtuLibur = document.getElementById("sabtuLibur").checked;

          let days = [];
          for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, mIdx, d);
            const dayNum = dateObj.getDay();
            const isHol =
              manualHolidays.includes(d) ||
              dayNum === 0 ||
              (sabtuLibur && dayNum === 6);
            days.push({ d, isHol });
          }
          return days;
        },

        tambahPegawai() {
          const newNama = document.getElementById("newNama").value.trim();
          if (!newNama) {
            alert("Nama pegawai baru harus diisi!");
            return;
          }
          const newTim = document.getElementById("newTim").value.trim();
          let listNama = document.getElementById("listNama").value.trim();
          if (listNama) listNama += "\n";
          if (newTim) {
            listNama += `[${newTim}] ${newNama}`;
          } else {
            listNama += newNama;
          }
          document.getElementById("listNama").value = listNama;
          document.getElementById("newNama").value = "";
          document.getElementById("newTim").value = "";
          this.render();
        },

        // Helper: Cycle Status ONLY (No typing)
        handleCellClick(idx, day, key, el) {
          const val = el.innerText.trim().toUpperCase();

          // Cycle sequence: Empty -> A -> I -> S -> Empty
          const cycles = ["", "A", "I", "S"];
          let currIdx = cycles.indexOf(val);
          // If unknown value, reset to first in cycle
          if (currIdx === -1) currIdx = 0;

          const nextVal = cycles[(currIdx + 1) % cycles.length];

          // Update UI immediately (Optimistic UI)
          el.innerText = nextVal;

          // Update Data & Smart Status without full re-render
          this.updateAttendance(idx, day, key, nextVal, false);
        },

        // Updated: skipRender=true by default to support click cycling without heavy refresh
        updateAttendance(idx, day, key, val, skipRender = true) {
          val = val.toUpperCase();
          this.data.attendance[`${idx}-${day}-${key}`] = val;

          // Smart Status Logic
          const specialStatus = ["A", "S", "I"];
          const relevantKeys = ["in", "out", "sign_in", "sign_out"];

          // If updating one of the relevant keys with a special status, update others
          if (relevantKeys.includes(key) && specialStatus.includes(val)) {
            relevantKeys.forEach((k) => {
              this.data.attendance[`${idx}-${day}-${k}`] = val;
              // Update DOM if we are skipping full render
              if (!skipRender) {
                const cellId = `cell-${idx}-${day}-${k}`;
                const cell = document.getElementById(cellId);
                if (cell) {
                  cell.innerText = val;
                  // Update classes
                  cell.className = cell.className
                    .replace(/status-[A-Z]/g, "")
                    .trim();
                  cell.classList.add(`status-${val}`);
                }
              }
            });
          } else if (relevantKeys.includes(key) && val === "") {
            // If clearing status, clear related fields too?
            relevantKeys.forEach((k) => {
              const currentVal = this.data.attendance[`${idx}-${day}-${k}`];
              if (specialStatus.includes(currentVal)) {
                this.data.attendance[`${idx}-${day}-${k}`] = "";
                if (!skipRender) {
                  const cellId = `cell-${idx}-${day}-${k}`;
                  const cell = document.getElementById(cellId);
                  if (cell) {
                    cell.innerText = "";
                    cell.className = cell.className
                      .replace(/status-[A-Z]/g, "")
                      .trim();
                  }
                }
              }
            });
          }

          // Also update current cell class if skipping render
          if (!skipRender) {
            const cellId = `cell-${idx}-${day}-${key}`;
            const cell = document.getElementById(cellId);
            if (cell) {
              cell.className = cell.className
                .replace(/status-[A-Z]/g, "")
                .trim();
              if (specialStatus.includes(val))
                cell.classList.add(`status-${val}`);
            }
          }

          this.saveState();
          if (skipRender) this.render();
        },

        render() {
          this.saveState();

          const judulLaporan = document.getElementById("judulLaporan").value;
          const mIdx = parseInt(document.getElementById("bulan").value);
          const year = parseInt(document.getElementById("tahun").value);
          const namesRaw = document
            .getElementById("listNama")
            .value.split("\n")
            .filter((n) => n.trim());

          const modeTim = document.getElementById("modeTim").checked;
          const showShift = document.getElementById("toggleShift").checked;
          const showDatang = document.getElementById("toggleDatang").checked;
          const showPulang = document.getElementById("togglePulang").checked;
          const showParaf = document.getElementById("toggleParaf").checked;

          this.timMap = {};
          let names = [];
          namesRaw.forEach((line, idx) => {
            let match = line.match(/^\s*\[(.+?)\]\s*(.+)$/);
            if (match) {
              this.timMap[idx] = match[1];
              names.push(match[2]);
            } else {
              this.timMap[idx] = null;
              names.push(line.trim());
            }
          });

          let groupedData = [];
          if (modeTim) {
            let mapTim = {};
            let noTimList = [];
            names.forEach((name, i) => {
              let t = this.timMap[i];
              if (!t) {
                noTimList.push({ idx: i, name });
              } else {
                if (!mapTim[t]) mapTim[t] = [];
                mapTim[t].push({ idx: i, name });
              }
            });
            groupedData = Object.entries(mapTim).map(([tim, members]) => ({
              tim,
              members,
            }));
            if (noTimList.length > 0) {
              groupedData.push({ tim: null, members: noTimList });
            }
          } else {
            groupedData = [
              {
                tim: null,
                members: names.map((name, i) => ({ idx: i, name })),
              },
            ];
          }

          const logo =
            document.getElementById("logoUrl").value ||
            "https://cdn-icons-png.flaticon.com/512/9386/9386918.png";
          const daysData = this.getDaysArray();

          document.getElementById("viewJudulInstansi").innerText =
            "RUMAH SAKIT UMUM PENYANGGA PERBATASAN BETUN";
          document.getElementById(
            "viewSubJudul"
          ).innerText = `${judulLaporan} - BULAN ${this.months[mIdx]} ${year}`;
          document.getElementById("viewLogo").src = logo;

          let html = `<thead><tr>
        <th class="col-no" rowspan="2">NO</th>
        <th class="col-nama" rowspan="2" style="text-align:center;">NAMA PEGAWAI</th>
        <th colspan="${daysData.length}">TANGGAL</th>
      </tr><tr>`;
          daysData.forEach((day) => {
            const cls = day.isHol ? "st-libur" : "";
            html += `<th class="${cls}" style="width:24px;">${day.d}</th>`;
          });
          html += `</tr></thead>`; 

          let rowsConfig = [];
          if (showShift) rowsConfig.push({ lbl: "Shift", key: "shift" });
          if (showDatang) rowsConfig.push({ lbl: "Jam Datang", key: "in" });
          if (showParaf) rowsConfig.push({ lbl: "Paraf", key: "sign_in" });
          if (showPulang) rowsConfig.push({ lbl: "Jam Pulang", key: "out" });
          if (showParaf) rowsConfig.push({ lbl: "Paraf", key: "sign_out" });

          let anggotaNo = 1;
          let employeeCount = 0;
          let totalGroups = groupedData.length;

          groupedData.forEach((group, gIdx) => {
            html += `<tbody>`;

            if (modeTim && group.tim !== null) {
              html += `<tr style="page-break-after: avoid; break-after: avoid;">
              <td colspan="${
                2 + daysData.length
              }" style="font-weight:bold; background:#eef2ff; font-size:0.9rem; text-align:left; padding-left:8px; border-bottom:1px solid #000;">
                <span style="font-weight:800; color:var(--primary-dark);">${
                  group.tim
                }</span>
              </td></tr>`;
            }

            let groupMemberCount = group.members.length;

            group.members.forEach(({ idx, name }, mIdx) => {
              employeeCount++;
              
              // LOGIKA SMART PAGE BREAK UNTUK TTD (Requirement 1)
              // Jika ini adalah orang terakhir di grup terakhir
              let isLastPersonOverall = (gIdx === totalGroups - 1) && (mIdx === groupMemberCount - 1);
              
              let breakStyle = "";
              const shouldCheckBreak = modeTim && group.tim !== null ? mIdx > 0 : true;

              if (shouldCheckBreak && employeeCount > 5 && (employeeCount - 1) % 5 === 0) {
                breakStyle = "page-break-before: always; break-before: always;";
              }

              // Jika ini orang terakhir, kita paksa JANGAN break after, supaya TTD nempel
              if(isLastPersonOverall) {
                  breakStyle += "page-break-after: avoid; break-after: avoid;";
              }

              let trStyle = `${breakStyle} page-break-after: avoid; break-after: avoid;`;
              if (gIdx === 0 && mIdx === 0) trStyle += ""; 

              html += `<tr class="${gIdx === 0 && mIdx === 0 ? "first-row" : ""}" style="${trStyle}">
              <td rowspan="${rowsConfig.length + 1}" style="font-weight:bold; border-bottom:2px solid #000;">${anggotaNo++}</td>
              <td colspan="${daysData.length + 1}" class="col-nama" title="Klik untuk hapus baris ini" onclick="App.clearRow(${idx})" style="border-bottom:none;">${name}</td>
            </tr>`;

              rowsConfig.forEach((cfg, rIdx) => {
                let isLastDetail = rIdx === rowsConfig.length - 1;
                let borderStyle = isLastDetail ? "border-bottom:2px solid #000;" : "";
                
                // Logic untuk baris detail terakhir orang terakhir
                let breakDetail = isLastDetail ? "" : "page-break-after: avoid; break-after: avoid;";
                
                // Jika ini baris detail terakhir DARI ORANG TERAKHIR, tambahkan avoid break juga agar nempel TTD
                if (isLastPersonOverall && isLastDetail) {
                    breakDetail = "page-break-after: avoid; break-after: avoid;";
                }

                html += `<tr style="${borderStyle} ${breakDetail}"><td class="col-ket">${cfg.lbl}</td>`;

                daysData.forEach((day) => {
                  const bgClass = day.isHol ? "st-libur" : "";
                  let val = this.data.attendance[`${idx}-${day.d}-${cfg.key}`] || "";
                  let clickAttr = "";
                  let textClass = "";

                  const cellId = `cell-${idx}-${day.d}-${cfg.key}`;

                  if (cfg.key === "shift") {
                    clickAttr = `onclick="App.cycleShiftTeam(${idx}, '${this.timMap[idx] || ""}', ${day.d}, this)"`;
                    textClass = "cell-input";
                    if (val === "P") textClass += " status-P";
                    else if (val === "S") textClass += " status-S";
                    else if (val === "M") textClass += " status-M";
                    else if (val === "L") textClass += " status-L";
                    html += `<td id="${cellId}" class="${bgClass} ${textClass}" ${clickAttr}>${val}</td>`;
                  } else {
                    if (val === "A") textClass += " status-A";
                    else if (val === "S") textClass += " status-S";
                    else if (val === "I") textClass += " status-I";
                    html += `<td id="${cellId}" class="${bgClass} ${textClass} cell-input" 
                             onclick="App.handleCellClick(${idx}, ${day.d}, '${cfg.key}', this)">${val}</td>`;
                  }
                });
                html += `</tr>`;
              });
            });

            html += `</tbody>`; 
          });

          document.getElementById("mainTable").innerHTML = html;

          document.getElementById("signatureSection").innerHTML =
            this.getTTDHTML(year, mIdx, daysData.length, 2 + daysData.length);
        },

        getTTDHTML(year, mIdx, daysCount, colspan) {
          const fields = [
            "ttd1_jabatan",
            "ttd1_nama",
            "ttd1_nip",
            "ttd2_jabatan",
            "ttd2_kota",
            "ttd2_nama",
            "ttd2_nip",
          ];
          const v = {};
          fields.forEach(
            (f) =>
              (v[f] = document.getElementById(f).value || "..................")
          );

          return `
            <tr class="signature-row">
                <td colspan="${colspan}">
                    <div class="footer-ttd">
                        <div class="ttd-block">
                            <p style="margin:0;">Mengetahui,<br>${v.ttd1_jabatan}</p>
                            <div class="ttd-space"></div>
                            <p style="margin:0;"><u><b>${v.ttd1_nama}</b></u><br>NIP. ${v.ttd1_nip}</p>
                        </div>
                        <div class="ttd-block">
                            <p style="margin:0;">${v.ttd2_kota}, ${daysCount} ${this.months[mIdx]} ${year}<br>${v.ttd2_jabatan}</p>
                            <div class="ttd-space"></div>
                            <p style="margin:0;"><u><b>${v.ttd2_nama}</b></u><br>NIP. ${v.ttd2_nip}</p>
                        </div>
                    </div>
                </td>
            </tr>`;
        },

        cycleShiftTeam(idx, timName, day, el) {
          const cycles = ["", "P", "S", "M", "L"];
          let currVal = el.innerText;
          let currIdx = cycles.indexOf(currVal);
          if (currIdx === -1) currIdx = 0;
          let nextVal = cycles[(currIdx + 1) % cycles.length];

          const modeTim = document.getElementById("modeTim").checked;
          if (modeTim && timName) {
            Object.entries(this.timMap).forEach(([k, v]) => {
              if (v === timName) {
                this.data.attendance[`${k}-${day}-shift`] = nextVal;
              }
            });
          } else {
            this.data.attendance[`${idx}-${day}-shift`] = nextVal;
          }
          this.saveState();
          this.render();
        },

        clearRow(idx) {
          if (
            confirm(
              `Hapus semua data absensi untuk baris pegawai ke-${idx + 1}?`
            )
          ) {
            const prefix = `${idx}-`;
            Object.keys(this.data.attendance).forEach((k) => {
              if (k.startsWith(prefix)) delete this.data.attendance[k];
            });
            this.render();
          }
        },

        // Updated for Requirement 8
        showStats(type = 'shift') {
          const names = document
            .getElementById("listNama")
            .value.split("\n")
            .filter((n) => n.trim());
          const daysData = this.getDaysArray();
          let html = `<thead><tr><th>Nama Pegawai</th>`;
          
          let cols = [];
          if (type === 'shift') {
             cols = ["P", "S", "M", "L"];
             document.getElementById('statsTitle').innerText = "Rekapitulasi Shift (P/S/M/L)";
          } else {
             cols = ["H", "S", "I", "A"]; // Hadir, Sakit, Izin, Alpa
             document.getElementById('statsTitle').innerText = "Rekapitulasi Kehadiran";
          }
          
          cols.forEach((c) => (html += `<th>${c}</th>`));
          html += `<th>Total</th></tr></thead><tbody>`;

          names.forEach((rawName, idx) => {
            let cleanName = rawName.replace(/^\s*\[.+?\]\s*/, "");
            let counts = {};
            cols.forEach((c) => (counts[c] = 0));
            let total = 0;
            
            daysData.forEach((day) => {
              if(type === 'shift') {
                  let key = `${idx}-${day.d}-shift`;
                  let val = this.data.attendance[key];
                  if (val && counts[val] !== undefined) {
                    counts[val]++;
                    total++;
                  }
              } else {
                  // Status check (Smart Logic)
                  let statusVal = "";
                  // Cek apakah ada A/S/I di salah satu cell
                  let s1 = this.data.attendance[`${idx}-${day.d}-in`] || "";
                  let s2 = this.data.attendance[`${idx}-${day.d}-out`] || "";
                  
                  if(s1 === "A" || s2 === "A") statusVal = "A";
                  else if(s1 === "S" || s2 === "S") statusVal = "S";
                  else if(s1 === "I" || s2 === "I") statusVal = "I";
                  else if(!day.isHol) statusVal = "H"; // Default hadir jika tidak libur

                  if(statusVal && counts[statusVal] !== undefined) {
                      counts[statusVal]++;
                      total++;
                  }
              }
            });
            html += `<tr><td style="text-align:left; font-weight:bold;">${cleanName}</td>`;
            cols.forEach((c) => (html += `<td>${counts[c]}</td>`));
            html += `<td>${total}</td></tr>`;
          });
          html += `</tbody>`;
          document.getElementById("statTableContent").innerHTML = html;
          document.getElementById("statsModal").style.display = "flex";
        },

        // Requirement 4: WA Feature Updated
        sendWA() {
            // Ambil Info Periode
            const mIdx = document.getElementById("bulan").value;
            const y = document.getElementById("tahun").value;
            const period = `${this.months[mIdx]} ${y}`;

            // Pesan Otomatis (Tanpa nomor HP, pilih kontak sendiri)
            const text = `Lapor Laporan Pekerjaan\nPeriode: ${period}\n\nTerlampir:\n1. File Absensi (PDF)\n2. File Backup Data (JSON)\n\nTerima Kasih.`;
            const msg = encodeURIComponent(text);
            
            // Universal Link WA agar bisa pilih kontak
            window.open(`https://api.whatsapp.com/send?text=${msg}`, '_blank');
        },

        previewPDF() {
             // Create a new window
             const printWindow = window.open('', '_blank');
             const content = document.querySelector('.main-area').innerHTML;
             const styles = document.querySelector('style').innerHTML;
             
             printWindow.document.write(`
                <html>
                  <head>
                    <title>Preview PDF</title>
                    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
                    <style>
                        ${styles}
                        body { background: #525659; display:flex; justify-content:center; padding:20px; }
                        .paper { transform: none !important; margin: 0; }
                    </style>
                  </head>
                  <body>
                    ${content}
                  </body>
                </html>
             `);
             printWindow.document.close();
        },

        saveState() {
          const state = {
            attendance: this.data.attendance,
            inputs: {
              judulLaporan: document.getElementById("judulLaporan").value,
              bulan: document.getElementById("bulan").value,
              tahun: document.getElementById("tahun").value,
              toggleShift: document.getElementById("toggleShift").checked,
              toggleDatang: document.getElementById("toggleDatang").checked,
              togglePulang: document.getElementById("togglePulang").checked,
              toggleParaf: document.getElementById("toggleParaf").checked,
              modeTim: document.getElementById("modeTim").checked,
              sabtuLibur: document.getElementById("sabtuLibur").checked,
              libur: document.getElementById("libur").value,
              listNama: document.getElementById("listNama").value,
              headerColor: document.getElementById("headerColor").value,
              logoUrl: document.getElementById("logoUrl").value,
              ttd1_jabatan: document.getElementById("ttd1_jabatan").value,
              ttd1_nama: document.getElementById("ttd1_nama").value,
              ttd1_nip: document.getElementById("ttd1_nip").value,
              ttd2_jabatan: document.getElementById("ttd2_jabatan").value,
              ttd2_kota: document.getElementById("ttd2_kota").value,
              ttd2_nama: document.getElementById("ttd2_nama").value,
              ttd2_nip: document.getElementById("ttd2_nip").value
            },
          };
          localStorage.setItem("absenProData", JSON.stringify(state));
        },

        loadState() {
          const saved = localStorage.getItem("absenProData");
          if (saved) {
            try {
              const state = JSON.parse(saved);
              this.data.attendance = state.attendance || {};
              if (state.inputs) {
                for (const [key, val] of Object.entries(state.inputs)) {
                  const el = document.getElementById(key);
                  if (el) {
                    if (el.type === "checkbox") el.checked = val;
                    else el.value = val;
                  }
                }
                document.documentElement.style.setProperty(
                  "--table-header-bg",
                  state.inputs.headerColor
                );
              }
            } catch (e) {
              console.error("Error loading state", e);
            }
          }
        },

        backupData() {
          const saved = localStorage.getItem("absenProData");
          if (!saved) return alert("Belum ada data tersimpan.");
          const blob = new Blob([saved], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `backup_absen_${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          a.click();
          URL.revokeObjectURL(url);
        },

        restoreData(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                JSON.parse(e.target.result);
                localStorage.setItem("absenProData", e.target.result);
                location.reload();
              } catch (err) {
                alert("File backup tidak valid!");
              }
            };
            reader.readAsText(input.files[0]);
          }
        },

        resetData() {
          if (
            confirm(
              "Apakah Anda yakin ingin mereset SEMUA data dan pengaturan?"
            )
          ) {
            localStorage.removeItem("absenProData");
            localStorage.removeItem("absenProTheme"); // Clear theme too
            location.reload();
          }
        },
      };

      window.onload = () => App.init();
    </script>
  </body>
</html>
