<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Absen Pro Ultimate + Features</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>

    <style>
      :root {
        --primary: #4f46e5; /* Indigo */
        --primary-dark: #4338ca;
        --secondary: #64748b;
        --bg-body: #f1f5f9;
        --bg-panel: #ffffff;
        --border: #e2e8f0;
        --danger: #ef4444;
        --success: #22c55e;
        --warning: #f59e0b;
        --paper-width: 297mm; /* A4 Landscape default, will auto-adjust in print */
      }

      * {
        box-sizing: border-box;
        outline: none;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-body);
        margin: 0;
        display: flex;
        height: 100vh;
        color: #1e293b;
        overflow: hidden;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        width: 360px;
        background: var(--bg-panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        z-index: 20;
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.02);
        transition: transform 0.3s ease;
      }
      .brand {
        padding: 20px;
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--primary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Tabs Navigation */
      .tabs {
        display: flex;
        background: #f8fafc;
        padding: 5px;
        gap: 5px;
        border-bottom: 1px solid var(--border);
      }
      .tab-btn {
        flex: 1;
        padding: 10px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--secondary);
        border-radius: 6px;
        transition: 0.2s;
      }
      .tab-btn.active {
        background: white;
        color: var(--primary);
        shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .tab-btn:hover:not(.active) {
        background: #e2e8f0;
      }

      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      .tab-panel {
        display: none;
        animation: fadeIn 0.3s;
      }
      .tab-panel.active {
        display: block;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--secondary);
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: 0.2s;
        background: #f8fafc;
      }
      input:focus,
      textarea:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      textarea {
        resize: vertical;
        min-height: 100px;
        font-family: monospace;
      }

      .row-inputs {
        display: flex;
        gap: 10px;
      }
      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }
      .btn-outline {
        background: white;
        border: 1px solid #cbd5e1;
        color: #334155;
        margin-top: 10px;
      }
      .btn-outline:hover {
        background: #f1f5f9;
      }
      .btn-danger {
        background: #fee2e2;
        color: var(--danger);
      }
      .btn-danger:hover {
        background: #fecaca;
      }
      .btn-success {
        background: #dcfce7;
        color: var(--success);
        margin-top: 10px;
      }
      .btn-success:hover {
        background: #bbf7d0;
      }
      .btn-warning {
        background: #fef3c7;
        color: #b45309;
        margin-top: 10px;
      }
      .btn-warning:hover {
        background: #fde68a;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 0.8rem;
        width: auto;
        display: inline-flex;
      }

      /* --- MAIN PREVIEW --- */
      .main-area {
        flex: 1;
        overflow: auto;
        padding: 40px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        position: relative;
      }

      .paper {
        background: white;
        width: var(--paper-width);
        min-height: 210mm;
        padding: 15mm 10mm;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      /* --- TABLE STYLING --- */
      .header-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        border-bottom: 3px double #000;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }
      .logo-img {
        height: 80px;
        width: 80px;
        object-fit: contain;
      }
      .header-text {
        text-align: center;
        color: #000;
      }
      .header-text h1 {
        margin: 0;
        font-size: 18pt;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .header-text h3 {
        margin: 5px 0 0 0;
        font-size: 12pt;
        font-weight: normal;
        text-transform: uppercase;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
        border: 2px solid #000;
        table-layout: fixed;
      }
      th,
      td {
        border: 1px solid #000;
        padding: 4px 2px;
        text-align: center;
        vertical-align: middle;
        color: #000;
      }

      /* Dynamic Header Color */
      thead th {
        background-color: var(--table-header-bg, #f1f5f9);
        height: 35px;
        font-weight: bold;
      }

      .col-no {
        width: 30px;
      }
      .col-nama {
        width: 220px;
        text-align: left;
        padding-left: 8px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-right: 2px solid #000;
        cursor: pointer;
      }
      .col-nama:hover {
        background-color: #f1f5f9;
        color: var(--primary);
        text-decoration: underline;
      }
      .col-ket {
        width: 60px;
        font-size: 8pt;
        font-style: italic;
        background: #fafafa;
        border-right: 2px solid #000;
        text-align: right;
        padding-right: 5px;
      }

      /* Cell Interactions */
      .cell-input {
        cursor: pointer;
        font-family: "Courier New", monospace;
        font-weight: bold;
        font-size: 10pt;
        transition: background 0.1s;
      }
      .cell-input:hover {
        background-color: #e0e7ff;
      }

      /* Status Colors */
      .st-libur {
        background-color: #ffcccc !important;
        color: #990000;
      } /* Merah Libur */
      .st-today {
        background-color: #fef08a;
      } /* Kuning Hari Ini */

      /* Footer TTD inside Table */
      .signature-row td {
        border: none !important; /* Hilangkan garis untuk baris TTD */
        padding-top: 30px;
        background-color: white !important;
      }
      .footer-ttd {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding: 0 20px;
      }
      .ttd-block {
        text-align: center;
        min-width: 220px;
        break-inside: avoid; /* Mencegah blok TTD terpotong */
      }
      .ttd-space {
        height: 80px;
      }

      /* --- MODAL STATS --- */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(2px);
      }
      .modal-box {
        background: white;
        width: 600px;
        max-height: 80vh;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .modal-header {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
      }
      .modal-content {
        overflow-y: auto;
        flex: 1;
      }
      .stat-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        border: none;
      }
      .stat-table th,
      .stat-table td {
        border: 1px solid #e2e8f0;
        padding: 8px;
        text-align: center;
      }
      .stat-table th {
        background: #f8fafc;
        text-align: left;
      }
      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
      }

      /* Responsive */
      @media (max-width: 1024px) {
        body {
          flex-direction: column;
          height: auto;
          overflow-y: auto;
        }
        .sidebar {
          width: 100%;
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
        .main-area {
          padding: 10px;
          background: #cbd5e1;
        }
        .paper {
          transform: scale(0.7);
          transform-origin: top left;
          margin-bottom: -30%;
        }
      }

      /* PRINT SETTINGS */
      @media print {
        body {
          background: white;
          height: auto;
          overflow: visible;
          display: block;
        }
        .sidebar,
        .modal-overlay {
          display: none !important;
        }

        .main-area {
          padding: 0;
          margin: 0;
          display: block;
          overflow: visible;
          width: 100%;
          height: auto;
        }
        .paper {
          box-shadow: none;
          margin: 0;
          width: 100% !important;
          max-width: 100% !important;
          min-width: 100% !important;
          padding: 0;
          border: none;
          transform: none !important;
        }

        /* Trik agar baris terakhir dan TTD nempel */
        tr {
          page-break-inside: avoid;
        }

        @page {
          size: landscape;
          margin: 5mm;
        }
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="brand">
        <i class="fa-solid fa-calendar-check"></i> AbsenPro Ultimate
      </div>

      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab-umum')">
          Umum
        </button>
        <button class="tab-btn" onclick="switchTab('tab-pegawai')">
          Pegawai
        </button>
        <button class="tab-btn" onclick="switchTab('tab-ttd')">
          Tanda Tangan
        </button>
      </div>

      <div class="sidebar-content">
        <div id="tab-umum" class="tab-panel active">
          <div class="form-group">
            <label>Judul Laporan (Daftar Hadir)</label>
            <input
              type="text"
              id="judulLaporan"
              value="DAFTAR HADIR PEGAWAI"
              oninput="App.render()"
            />
          </div>

          <div class="form-group">
            <label>Periode Absensi</label>
            <div class="row-inputs">
              <select id="bulan" onchange="App.render()"></select>
              <input
                type="number"
                id="tahun"
                style="width: 80px"
                onchange="App.render()"
              />
            </div>
          </div>

          <div class="form-group">
            <label>Mode Absen</label>
            <select id="modeAbsen" onchange="App.render()">
              <option value="shift">Mode Shift (P, S, M, L)</option>
              <option value="admin">Mode Status (H, S, I, A)</option>
            </select>
          </div>

          <div class="form-group">
            <label>Hari Libur</label>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                margin-bottom: 5px;
              "
            >
              <input
                type="checkbox"
                id="sabtuLibur"
                style="width: auto"
                onchange="App.render()"
              />
              <span style="font-size: 0.9rem">Sabtu Merah</span>
            </div>
            <input
              type="text"
              id="libur"
              placeholder="Tanggal merah manual (Cth: 1, 17)"
              oninput="App.render()"
            />
          </div>

          <div class="form-group">
            <label>Magic Fill (Isi Cepat)</label>
            <div class="row-inputs">
              <select id="fillValue">
                <option value="P">P (Pagi)</option>
                <option value="S">S (Siang)</option>
                <option value="M">M (Malam)</option>
                <option value="H">H (Hadir)</option>
                <option value="L">L (Libur)</option>
              </select>
              <button
                class="btn btn-primary btn-small"
                onclick="App.magicFill()"
              >
                <i class="fa-solid fa-wand-magic-sparkles"></i> Isi
              </button>
            </div>
            <small style="color: #666; font-size: 10px"
              >*Mengisi semua kolom kosong pada hari kerja.</small
            >
          </div>

          <div class="form-group">
            <label>Tampilan</label>
            <input
              type="color"
              id="headerColor"
              value="#f1f5f9"
              style="height: 40px; padding: 2px; cursor: pointer"
              oninput="App.updateColor()"
            />
            <input
              type="text"
              id="logoUrl"
              placeholder="Logo URL..."
              oninput="App.render()"
              style="margin-top: 5px"
            />
            <input
              type="file"
              id="logoFile"
              accept="image/*"
              style="margin-top: 5px; font-size: 11px"
              onchange="App.handleLogoUpload(this)"
            />
          </div>

          <hr style="border-top: 1px dashed #ccc; margin: 20px 0" />

          <button class="btn btn-warning" onclick="App.showStats()">
            <i class="fa-solid fa-chart-simple"></i> Lihat Rekapitulasi
          </button>
          <div class="row-inputs" style="margin-top: 10px">
            <button class="btn btn-outline" onclick="App.backupData()">
              <i class="fa-solid fa-download"></i> Backup
            </button>
            <button
              class="btn btn-outline"
              onclick="document.getElementById('fileRestore').click()"
            >
              <i class="fa-solid fa-upload"></i> Restore
            </button>
            <input
              type="file"
              id="fileRestore"
              style="display: none"
              onchange="App.restoreData(this)"
            />
          </div>

          <button class="btn btn-success" onclick="App.downloadExcel()">
            <i class="fa-solid fa-file-excel"></i> Excel
          </button>
          <button
            class="btn btn-primary"
            style="margin-top: 10px"
            onclick="window.print()"
          >
            <i class="fa-solid fa-print"></i> PDF
          </button>
          <button
            class="btn btn-danger"
            style="margin-top: 10px"
            onclick="App.resetData()"
          >
            <i class="fa-solid fa-trash"></i> Reset All
          </button>
        </div>

        <div id="tab-pegawai" class="tab-panel">
          <div class="form-group">
            <label>Daftar Nama (1 Baris = 1 Orang)</label>
            <textarea
              id="listNama"
              style="height: 300px"
              placeholder="Ketik nama pegawai..."
              onblur="App.render()"
            ></textarea>
            <small style="color: #666; font-size: 11px"
              >*Klik nama di preview untuk reset baris.</small
            >
          </div>
        </div>

        <div id="tab-ttd" class="tab-panel">
          <div class="form-group">
            <label>Kiri (Mengetahui)</label>
            <input
              type="text"
              id="ttd1_jabatan"
              placeholder="Jabatan (mis: Direktur)"
              class="mb-1"
            />
            <input
              type="text"
              id="ttd1_nama"
              placeholder="Nama Pejabat"
              style="margin-top: 5px"
            />
            <input
              type="text"
              id="ttd1_nip"
              placeholder="NIP"
              style="margin-top: 5px"
            />
          </div>
          <hr />
          <div class="form-group">
            <label>Kanan (Pembuat/Ka. Ruang)</label>
            <input type="text" id="ttd2_jabatan" placeholder="Jabatan" />
            <input
              type="text"
              id="ttd2_kota"
              placeholder="Kota (mis: Jakarta)"
              style="margin-top: 5px"
            />
            <input
              type="text"
              id="ttd2_nama"
              placeholder="Nama Pegawai"
              style="margin-top: 5px"
            />
            <input
              type="text"
              id="ttd2_nip"
              placeholder="NIP"
              style="margin-top: 5px"
            />
          </div>
          <button class="btn btn-primary" onclick="App.render()">
            Terapkan TTD
          </button>
        </div>
      </div>
    </aside>

    <main class="main-area">
      <div class="paper">
        <div class="header-section">
          <img
            id="viewLogo"
            src="https://cdn-icons-png.flaticon.com/512/9386/9386918.png"
            class="logo-img"
          />
          <div class="header-text">
            <h1 id="viewJudulInstansi">
              RUMAH SAKIT UMUM PENYANGGA PERBATASAN BETUN
            </h1>
            <h3 id="viewSubJudul"></h3>
          </div>
        </div>

        <table id="mainTable">
          <!-- Rendered JS will fill this -->
        </table>
        <!-- Area TTD moved inside table dynamically -->
      </div>
    </main>

    <!-- Modal Stats -->
    <div id="statsModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">
          <span>Rekapitulasi Absensi</span>
          <button
            class="close-btn"
            onclick="document.getElementById('statsModal').style.display='none'"
          >
            &times;
          </button>
        </div>
        <div class="modal-content">
          <table class="stat-table" id="statTableContent"></table>
        </div>
        <button
          class="btn btn-primary"
          style="margin-top: 15px"
          onclick="document.getElementById('statsModal').style.display='none'"
        >
          Tutup
        </button>
      </div>
    </div>

    <script>
      // --- LOGIC APP ---
      const App = {
        data: {
          attendance: {},
        },
        months: [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ],

        init() {
          const sel = document.getElementById("bulan");
          this.months.forEach((m, i) => sel.add(new Option(m, i)));

          const now = new Date();
          sel.value = now.getMonth();
          document.getElementById("tahun").value = now.getFullYear();
          document.getElementById("listNama").value =
            "Dr. Budi Santoso\nSuster Siti Aminah\nPerawat Joko\nAdmin Rina";

          this.loadState();
          this.render();
        },

        handleLogoUpload(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("logoUrl").value = e.target.result;
              App.render();
            };
            reader.readAsDataURL(input.files[0]);
          }
        },

        updateColor() {
          const col = document.getElementById("headerColor").value;
          document.documentElement.style.setProperty("--table-header-bg", col);
          this.saveState();
        },

        getDaysArray() {
          const mIdx = parseInt(document.getElementById("bulan").value);
          const year = parseInt(document.getElementById("tahun").value);
          const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
          const manualHolidays = document
            .getElementById("libur")
            .value.split(",")
            .map((n) => parseInt(n));
          const sabtuLibur = document.getElementById("sabtuLibur").checked;

          let days = [];
          for (let d = 1; d <= daysInMonth; d++) {
            let dateObj = new Date(year, mIdx, d);
            let dayNum = dateObj.getDay(); // 0 Sun, 6 Sat
            let isHol =
              manualHolidays.includes(d) ||
              dayNum === 0 ||
              (sabtuLibur && dayNum === 6);
            days.push({ d, isHol });
          }
          return days;
        },

        render() {
          this.saveState();

          // Ambil Judul Laporan yang bisa diedit
          const judulLaporan = document.getElementById("judulLaporan").value;

          const mIdx = parseInt(document.getElementById("bulan").value);
          const year = parseInt(document.getElementById("tahun").value);
          const names = document
            .getElementById("listNama")
            .value.split("\n")
            .filter((n) => n.trim());
          const mode = document.getElementById("modeAbsen").value;
          const logo =
            document.getElementById("logoUrl").value ||
            "https://cdn-icons-png.flaticon.com/512/9386/9386918.png";
          const daysData = this.getDaysArray();

          // Judul Instansi FIX (Sudah di HTML, tapi kita pastikan di sini kalau-kalau direload)
          document.getElementById("viewJudulInstansi").innerText =
            "RUMAH SAKIT UMUM PENYANGGA PERBATASAN BETUN";

          // Update Sub Judul (Judul Laporan + Bulan)
          document.getElementById(
            "viewSubJudul"
          ).innerText = `${judulLaporan} - BULAN ${this.months[mIdx]} ${year}`;

          document.getElementById("viewLogo").src = logo;

          let html = `<thead><tr>
                    <th class="col-no" rowspan="2">NO</th>
                    <th class="col-nama" rowspan="2" style="text-align:center;">NAMA PEGAWAI</th>
                    <th colspan="${daysData.length}">TANGGAL</th>
                </tr><tr>`;

          daysData.forEach((day) => {
            let cls = day.isHol ? "st-libur" : "";
            html += `<th class="${cls}" style="width:24px;">${day.d}</th>`;
          });
          html += `</tr></thead><tbody>`;

          const rowsConfig =
            mode === "shift"
              ? [
                  { lbl: "Shift", key: "shift" },
                  { lbl: "Datang", key: "in" },
                  { lbl: "Paraf", key: "sign_in" },
                  { lbl: "Pulang", key: "out" },
                  { lbl: "Paraf", key: "sign_out" },
                ]
              : [
                  { lbl: "Status", key: "stat" },
                  { lbl: "Datang", key: "in" },
                  { lbl: "Paraf", key: "sign_in" },
                  { lbl: "Pulang", key: "out" },
                  { lbl: "Paraf", key: "sign_out" },
                ];

          names.forEach((name, idx) => {
            html += `<tr>
                        <td rowspan="${
                          rowsConfig.length + 1
                        }" style="font-weight:bold; border-bottom:2px solid #000;">${
              idx + 1
            }</td>
                        <td colspan="${
                          daysData.length + 1
                        }" class="col-nama" title="Klik untuk hapus baris ini" onclick="App.clearRow(${idx})" style="border-bottom:none;">${name}</td>
                    </tr>`;

            rowsConfig.forEach((cfg, rIdx) => {
              let isLast = rIdx === rowsConfig.length - 1;
              let borderStyle = isLast ? "border-bottom:2px solid #000;" : "";

              html += `<tr style="${borderStyle}">
                            <td class="col-ket">${cfg.lbl}</td>`;

              daysData.forEach((day) => {
                let bgClass = day.isHol ? "st-libur" : "";
                let cellKey = `${idx}-${day.d}-${cfg.key}`;
                let val = this.data.attendance[cellKey] || "";
                let clickAttr = "";
                let textClass = "";

                if (rIdx === 0) {
                  clickAttr = `onclick="App.cycleCell('${cellKey}', this, '${mode}')"`;
                  textClass = "cell-input";
                  if (["L", "M", "A", "S"].includes(val))
                    textClass += " text-danger";
                }

                html += `<td class="${bgClass} ${textClass}" ${clickAttr}>${val}</td>`;
              });
              html += `</tr>`;
            });
          });

          // --- INTEGRASI TTD KE DALAM TABEL ---
          const totalCols = 2 + daysData.length;
          html += this.getTTDHTML(year, mIdx, daysData.length, totalCols);

          html += `</tbody>`;
          document.getElementById("mainTable").innerHTML = html;
        },

        // Helper baru untuk generate HTML Tanda Tangan dalam Baris Tabel
        getTTDHTML(year, mIdx, daysCount, colspan) {
          const fields = [
            "ttd1_jabatan",
            "ttd1_nama",
            "ttd1_nip",
            "ttd2_jabatan",
            "ttd2_kota",
            "ttd2_nama",
            "ttd2_nip",
          ];
          const v = {};
          fields.forEach(
            (f) =>
              (v[f] = document.getElementById(f).value || "..................")
          );

          return `
                    <tr class="signature-row">
                        <td colspan="${colspan}">
                            <div class="footer-ttd">
                                <div class="ttd-block">
                                    <p>Mengetahui,<br>${v.ttd1_jabatan}</p>
                                    <div class="ttd-space"></div>
                                    <p><u><b>${v.ttd1_nama}</b></u><br>NIP. ${v.ttd1_nip}</p>
                                </div>
                                <div class="ttd-block">
                                    <p>${v.ttd2_kota}, ${daysCount} ${this.months[mIdx]} ${year}<br>${v.ttd2_jabatan}</p>
                                    <div class="ttd-space"></div>
                                    <p><u><b>${v.ttd2_nama}</b></u><br>NIP. ${v.ttd2_nip}</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
        },

        cycleCell(key, el, mode) {
          const cycles =
            mode === "shift"
              ? ["", "P", "S", "M", "L"]
              : ["", "H", "S", "I", "A", "C"];

          let currIdx = cycles.indexOf(el.innerText);
          if (currIdx === -1) currIdx = 0;
          let nextVal = cycles[(currIdx + 1) % cycles.length];

          el.innerText = nextVal;
          this.data.attendance[key] = nextVal;
          this.saveState();

          el.className = el.className.replace(" text-danger", "");
          if (["L", "M", "A", "S"].includes(nextVal))
            el.className += " text-danger";
        },

        // --- NEW FEATURES ---

        magicFill() {
          const fillVal = document.getElementById("fillValue").value;
          const names = document
            .getElementById("listNama")
            .value.split("\n")
            .filter((n) => n.trim());
          const daysData = this.getDaysArray();
          const mode = document.getElementById("modeAbsen").value;
          const keyType = mode === "shift" ? "shift" : "stat";

          let changed = false;
          names.forEach((_, idx) => {
            daysData.forEach((day) => {
              // Jangan isi jika hari libur atau sudah ada isinya
              if (!day.isHol) {
                let key = `${idx}-${day.d}-${keyType}`;
                if (!this.data.attendance[key]) {
                  this.data.attendance[key] = fillVal;
                  changed = true;
                }
              }
            });
          });

          if (changed) {
            this.render();
            alert("Berhasil mengisi otomatis!");
          } else {
            alert("Tidak ada sel kosong di hari kerja.");
          }
        },

        clearRow(idx) {
          if (
            confirm(
              `Hapus semua data absensi untuk baris pegawai ke-${idx + 1}?`
            )
          ) {
            const prefix = `${idx}-`;
            Object.keys(this.data.attendance).forEach((k) => {
              if (k.startsWith(prefix)) delete this.data.attendance[k];
            });
            this.render();
          }
        },

        showStats() {
          const names = document
            .getElementById("listNama")
            .value.split("\n")
            .filter((n) => n.trim());
          const daysData = this.getDaysArray();
          const mode = document.getElementById("modeAbsen").value;
          const keyType = mode === "shift" ? "shift" : "stat";

          let html = `<thead><tr><th>Nama Pegawai</th>`;

          // Define columns based on mode
          const cols =
            mode === "shift" ? ["P", "S", "M", "L"] : ["H", "S", "I", "A", "C"];

          cols.forEach((c) => (html += `<th>${c}</th>`));
          html += `<th>Total</th></tr></thead><tbody>`;

          names.forEach((name, idx) => {
            let counts = {};
            cols.forEach((c) => (counts[c] = 0));
            let total = 0;

            daysData.forEach((day) => {
              let key = `${idx}-${day.d}-${keyType}`;
              let val = this.data.attendance[key];
              if (val && counts[val] !== undefined) {
                counts[val]++;
                total++;
              }
            });

            html += `<tr><td style="text-align:left; font-weight:bold;">${name}</td>`;
            cols.forEach((c) => (html += `<td>${counts[c]}</td>`));
            html += `<td>${total}</td></tr>`;
          });

          html += `</tbody>`;
          document.getElementById("statTableContent").innerHTML = html;
          document.getElementById("statsModal").style.display = "flex";
        },

        backupData() {
          this.saveState();
          const json = localStorage.getItem("AbsenPro_Ult_v2");
          const blob = new Blob([json], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `Backup_Absen_${new Date()
            .toISOString()
            .slice(0, 10)}.json`;
          a.click();
        },

        restoreData(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = JSON.parse(e.target.result);
                localStorage.setItem("AbsenPro_Ult_v2", JSON.stringify(data));
                alert("Data berhasil dipulihkan!");
                location.reload();
              } catch (err) {
                alert("File backup tidak valid.");
              }
            };
            reader.readAsText(input.files[0]);
          }
        },

        downloadExcel() {
          const table = document.getElementById("mainTable");
          const wb = XLSX.utils.table_to_book(table, { sheet: "Absensi" });
          const ws = wb.Sheets["Absensi"];
          // Simple styling fix for excel
          const range = XLSX.utils.decode_range(ws["!ref"]);
          for (let R = range.s.r; R <= range.e.r; ++R) {
            for (let C = range.s.c; C <= range.e.c; ++C) {
              const cell_ref = XLSX.utils.encode_cell({ c: C, r: R });
              if (!ws[cell_ref]) continue;
              if (!ws[cell_ref].s) ws[cell_ref].s = {};
              ws[cell_ref].s.border = {
                top: { style: "thin" },
                bottom: { style: "thin" },
                left: { style: "thin" },
                right: { style: "thin" },
              };
              ws[cell_ref].s.alignment = {
                horizontal: "center",
                vertical: "center",
              };
            }
          }
          XLSX.writeFile(
            wb,
            `Absensi_${document.getElementById("bulan").value}.xlsx`
          );
        },

        saveState() {
          const state = {
            judul: document.getElementById("judulLaporan").value, // Simpan judul laporan custom
            bulan: document.getElementById("bulan").value,
            tahun: document.getElementById("tahun").value,
            names: document.getElementById("listNama").value,
            libur: document.getElementById("libur").value,
            sabtuLibur: document.getElementById("sabtuLibur").checked,
            mode: document.getElementById("modeAbsen").value,
            color: document.getElementById("headerColor").value,
            logo: document.getElementById("logoUrl").value,
            ttd: {
              t1j: document.getElementById("ttd1_jabatan").value,
              t1n: document.getElementById("ttd1_nama").value,
              t1i: document.getElementById("ttd1_nip").value,
              t2j: document.getElementById("ttd2_jabatan").value,
              t2k: document.getElementById("ttd2_kota").value,
              t2n: document.getElementById("ttd2_nama").value,
              t2i: document.getElementById("ttd2_nip").value,
            },
            data: this.data.attendance,
          };
          localStorage.setItem("AbsenPro_Ult_v2", JSON.stringify(state));
        },

        loadState() {
          const json = localStorage.getItem("AbsenPro_Ult_v2");
          if (!json) return;
          const s = JSON.parse(json);

          document.getElementById("judulLaporan").value =
            s.judul || "DAFTAR HADIR PEGAWAI"; // Load judul custom
          document.getElementById("bulan").value = s.bulan || 0;
          document.getElementById("tahun").value =
            s.tahun || new Date().getFullYear();
          document.getElementById("listNama").value = s.names || "";
          document.getElementById("libur").value = s.libur || "";
          document.getElementById("sabtuLibur").checked = s.sabtuLibur || false;
          document.getElementById("modeAbsen").value = s.mode || "shift";
          document.getElementById("headerColor").value = s.color || "#f1f5f9";
          document.getElementById("logoUrl").value = s.logo || "";

          if (s.ttd) {
            document.getElementById("ttd1_jabatan").value = s.ttd.t1j || "";
            document.getElementById("ttd1_nama").value = s.ttd.t1n || "";
            document.getElementById("ttd1_nip").value = s.ttd.t1i || "";
            document.getElementById("ttd2_jabatan").value = s.ttd.t2j || "";
            document.getElementById("ttd2_kota").value = s.ttd.t2k || "";
            document.getElementById("ttd2_nama").value = s.ttd.t2n || "";
            document.getElementById("ttd2_nip").value = s.ttd.t2i || "";
          }

          this.data.attendance = s.data || {};
          document.documentElement.style.setProperty(
            "--table-header-bg",
            s.color || "#f1f5f9"
          );
        },

        resetData() {
          if (confirm("Hapus semua data dan mulai dari awal?")) {
            localStorage.removeItem("AbsenPro_Ult_v2");
            location.reload();
          }
        },
      };

      function switchTab(tabId) {
        document
          .querySelectorAll(".tab-panel")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".tab-btn")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(tabId).classList.add("active");
        event.target.classList.add("active");
      }

      window.onload = () => App.init();
    </script>
  </body>
</html>
