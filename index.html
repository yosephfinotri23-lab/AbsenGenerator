<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Absen Pro Ultimate + Mode Tim & Individu + Sidebar Pegawai Lengkap</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.min.js"></script>
    <style>
      :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #64748b;
        --bg-body: #f1f5f9;
        --bg-panel: #ffffff;
        --border: #e2e8f0;
        --danger: #ef4444;
        --success: #22c55e;
        --warning: #f59e0b;
        --paper-width: 297mm;
        --table-header-bg: transparent;
      }
      * {
        box-sizing: border-box;
        outline: none;
      }
      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-body);
        margin: 0;
        display: flex;
        height: 100vh;
        color: #1e293b;
        overflow: hidden;
      }
      .sidebar {
        width: 360px;
        background: var(--bg-panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        z-index: 20;
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.02);
        flex-shrink: 0;
      }
      .brand {
        padding: 20px;
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--primary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .tabs {
        display: flex;
        background: #f8fafc;
        padding: 5px;
        gap: 5px;
        border-bottom: 1px solid var(--border);
      }
      .tab-btn {
        flex: 1;
        padding: 10px;
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--secondary);
        border-radius: 6px;
        transition: 0.2s;
      }
      .tab-btn.active {
        background: white;
        color: var(--primary);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .tab-btn:hover:not(.active) {
        background: #e2e8f0;
      }
      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      .tab-panel {
        display: none;
        animation: fadeIn 0.3s;
      }
      .tab-panel.active {
        display: block;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--secondary);
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #cbd5e1;
        border-radius: 8px;
        font-size: 0.9rem;
        transition: 0.2s;
        background: #f8fafc;
      }
      input:focus,
      textarea:focus {
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }
      textarea {
        resize: vertical;
        min-height: 100px;
        font-family: monospace;
      }
      .row-inputs {
        display: flex;
        gap: 10px;
      }
      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-primary:hover {
        background: var(--primary-dark);
      }
      .btn-outline {
        background: white;
        border: 1px solid #cbd5e1;
        color: #334155;
        margin-top: 10px;
      }
      .btn-outline:hover {
        background: #f1f5f9;
      }
      .btn-danger {
        background: #fee2e2;
        color: var(--danger);
      }
      .btn-danger:hover {
        background: #fecaca;
      }
      .btn-success {
        background: #dcfce7;
        color: var(--success);
        margin-top: 10px;
      }
      .btn-success:hover {
        background: #bbf7d0;
      }
      .btn-warning {
        background: #fef3c7;
        color: #b45309;
        margin-top: 10px;
      }
      .btn-warning:hover {
        background: #fde68a;
      }
      .btn-small {
        padding: 6px 12px;
        font-size: 0.8rem;
        width: auto;
        display: inline-flex;
      }
      .main-area {
        flex: 1;
        overflow: auto;
        padding: 40px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        position: relative;
        background-color: #cbd5e1;
      }
      .paper {
        background: white;
        width: var(--paper-width);
        min-width: var(--paper-width);
        min-height: 210mm;
        padding: 15mm 10mm;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.1);
        position: relative;
      }
      .header-section {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        border-bottom: 3px double #000;
        padding-bottom: 15px;
        margin-bottom: 20px;
      }
      .logo-img {
        height: 80px;
        width: 80px;
        object-fit: contain;
      }
      .header-text {
        text-align: center;
        color: #000;
      }
      .header-text h1 {
        margin: 0;
        font-size: 18pt;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .header-text h3 {
        margin: 5px 0 0 0;
        font-size: 12pt;
        font-weight: normal;
        text-transform: uppercase;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 9pt;
        border: 2px solid #000;
        table-layout: fixed;
      }
      th,
      td {
        border: 1px solid #000;
        padding: 4px 2px;
        text-align: center;
        vertical-align: middle;
        color: #000;
        background-color: transparent;
      }
      thead th {
        background-color: var(--table-header-bg, transparent);
        height: 35px;
        font-weight: bold;
      }
      .col-no {
        width: 30px;
      }
      .col-nama {
        width: 220px;
        text-align: left;
        padding-left: 8px;
        font-weight: 700;
        text-transform: uppercase;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border-right: 2px solid #000;
        cursor: pointer;
      }
      .col-nama:hover {
        background-color: #f1f5f9;
        color: var(--primary);
        text-decoration: underline;
      }
      .col-ket {
        width: 60px;
        font-size: 8pt;
        font-style: italic;
        background: #fafafa;
        border-right: 2px solid #000;
        text-align: right;
        padding-right: 5px;
      }
      .cell-input {
        cursor: pointer;
        font-family: "Courier New", monospace;
        font-weight: bold;
        font-size: 10pt;
        transition: background 0.1s;
      }
      .cell-input:hover {
        background-color: #e0e7ff !important;
      }
      .st-libur {
        background-color: #ffcccc !important;
        color: #990000;
      }
      .text-danger {
        color: #ef4444;
      }
      .signature-row td {
        border: none !important;
        padding-top: 30px;
        background-color: white !important;
      }
      .footer-ttd {
        display: flex;
        justify-content: space-between;
        width: 100%;
        padding: 0 20px;
      }
      .ttd-block {
        text-align: center;
        min-width: 220px;
        break-inside: avoid;
      }
      .ttd-space {
        height: 80px;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 100;
        display: none;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(2px);
      }
      .modal-box {
        background: white;
        width: 600px;
        max-height: 80vh;
        border-radius: 12px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }
      .modal-header {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
      }
      .modal-content {
        overflow-y: auto;
        flex: 1;
      }
      .stat-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        border: none;
      }
      .stat-table th,
      .stat-table td {
        border: 1px solid #e2e8f0;
        padding: 8px;
        text-align: center;
      }
      .stat-table th {
        background: #f8fafc;
        text-align: left;
      }
      .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #64748b;
      }
      @media (max-width: 1024px) {
        body {
          flex-direction: column;
          height: auto;
          overflow-y: auto;
        }
        .sidebar {
          width: 100%;
          height: auto;
          max-height: 40vh;
          border-right: none;
          border-bottom: 1px solid var(--border);
          overflow-y: auto;
        }
        .main-area {
          padding: 20px 10px;
          background: #cbd5e1;
          display: block;
          width: 100%;
          overflow: auto;
        }
        .paper {
          margin: 0 auto;
          width: 297mm;
          min-width: 297mm;
          transform: none;
          transform-origin: unset;
          margin-bottom: 20px;
        }
      }
      @media (max-width: 600px) {
        .brand {
          padding: 15px;
          font-size: 1.1rem;
        }
        .main-area {
          padding: 10px;
        }
        .header-text h1 {
          font-size: 14pt;
        }
        .header-text h3 {
          font-size: 10pt;
        }
        .logo-img {
          height: 60px;
          width: 60px;
        }
        .sidebar {
          max-height: 35vh;
        }
      }
      @media print {
        body {
          background: white;
          height: auto;
          overflow: visible;
          display: block;
        }
        .sidebar,
        .modal-overlay {
          display: none !important;
        }
        .main-area {
          padding: 0;
          margin: 0;
          display: block;
          overflow: visible;
          width: 100%;
          height: auto;
        }
        .paper {
          box-shadow: none;
          margin: 0;
          width: 100% !important;
          max-width: 100% !important;
          min-width: 100% !important;
          padding: 0;
          border: none;
          transform: none !important;
        }
        tr {
          page-break-inside: avoid;
        }
        @page {
          size: landscape;
          margin: 5mm;
        }
        * {
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
        }
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="brand">
        <i class="fa-solid fa-calendar-check"></i> AbsenPro Ultimate
      </div>
      <div class="tabs">
        <button
          id="btn-tab-umum"
          class="tab-btn active"
          onclick="App.switchTab('tab-umum')"
        >
          Umum
        </button>
        <button
          id="btn-tab-pegawai"
          class="tab-btn"
          onclick="App.switchTab('tab-pegawai')"
        >
          Pegawai
        </button>
        <button
          id="btn-tab-ttd"
          class="tab-btn"
          onclick="App.switchTab('tab-ttd')"
        >
          Tanda Tangan
        </button>
      </div>

      <div class="sidebar-content">
        <div id="tab-umum" class="tab-panel active">
          <div class="form-group">
            <label>Judul Laporan</label>
            <input
              type="text"
              id="judulLaporan"
              value="DAFTAR HADIR PEGAWAI"
              oninput="App.render()"
            />
          </div>
          <div class="form-group">
            <label>Periode Absensi</label>
            <div class="row-inputs">
              <select id="bulan" onchange="App.render()"></select>
              <input
                type="number"
                id="tahun"
                style="width: 80px"
                onchange="App.render()"
              />
            </div>
          </div>
          <div class="form-group">
            <label>Opsi Baris</label>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                background: #fff;
                padding: 10px;
                border: 1px solid #cbd5e1;
                border-radius: 8px;
              "
            >
              <input
                type="checkbox"
                id="toggleShift"
                style="width: auto; margin: 0; cursor: pointer;"
                onchange="App.render()"
                checked
              />
              <span
                style="font-size: 0.9rem; font-weight: 600; cursor: pointer;"
                onclick="document.getElementById('toggleShift').click()"
                >Tampilkan Baris Shift</span
              >
            </div>
          </div>

          <div class="form-group">
            <label>Mode Daftar Hadir</label>
            <div
              style="
                display: flex;
                align-items: center;
                gap: 8px;
                background: #fff;
                padding: 10px;
                border: 1px solid #cbd5e1;
                border-radius: 8px;
              "
            >
              <input
                type="checkbox"
                id="modeTim"
                style="width: auto; margin: 0; cursor: pointer;"
                onchange="App.render()"
              />
              <span
                style="font-size: 0.9rem; font-weight: 600; cursor: pointer;"
                onclick="document.getElementById('modeTim').click()"
                >Mode Tim</span
              >
            </div>
          </div>

          <div class="form-group">
            <label>Hari Libur</label>
            <div
              style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;"
            >
              <input
                type="checkbox"
                id="sabtuLibur"
                style="width: auto"
                onchange="App.render()"
              />
              <span style="font-size: 0.9rem">Sabtu Merah</span>
            </div>
            <input
              type="text"
              id="libur"
              placeholder="Tanggal merah manual (Cth: 1, 17)"
              oninput="App.render()"
            />
          </div>
          <div class="form-group">
            <label>Tampilan</label>
            <div class="row-inputs">
              <input
                type="color"
                id="headerColor"
                value="#ffffff"
                style="height: 40px; padding: 2px; cursor: pointer; flex:1;"
                oninput="App.updateColor()"
              />
              <button
                class="btn btn-outline btn-small"
                onclick="document.getElementById('logoFile').click()"
              >
                Ganti Logo
              </button>
            </div>
            <input
              type="text"
              id="logoUrl"
              placeholder="Atau paste URL Logo..."
              oninput="App.render()"
              style="margin-top: 5px"
            />
            <input
              type="file"
              id="logoFile"
              accept="image/*"
              style="display: none"
              onchange="App.handleLogoUpload(this)"
            />
          </div>
          <hr style="border-top: 1px dashed #ccc; margin: 20px 0" />
          <button class="btn btn-warning" onclick="App.showStats()">
            <i class="fa-solid fa-chart-simple"></i> Lihat Rekapitulasi
          </button>
          <div class="row-inputs" style="margin-top: 10px">
            <button class="btn btn-outline" onclick="App.backupData()">
              <i class="fa-solid fa-download"></i> Backup
            </button>
            <button
              class="btn btn-outline"
              onclick="document.getElementById('fileRestore').click()"
            >
              <i class="fa-solid fa-upload"></i> Restore
            </button>
            <input
              type="file"
              id="fileRestore"
              accept=".json"
              style="display: none"
              onchange="App.restoreData(this)"
            />
          </div>
          <button class="btn btn-success" onclick="App.downloadExcel()">
            <i class="fa-solid fa-file-excel"></i> Excel
          </button>
          <button
            class="btn btn-primary"
            style="margin-top: 10px"
            onclick="window.print()"
          >
            <i class="fa-solid fa-print"></i> PDF / Print
          </button>
          <button
            class="btn btn-danger"
            style="margin-top: 10px"
            onclick="App.resetData()"
          >
            <i class="fa-solid fa-trash"></i> Reset All
          </button>
        </div>

        <div id="tab-pegawai" class="tab-panel">
          <div class="form-group">
            <label>Daftar Nama Pegawai</label>
            <textarea
              id="listNama"
              style="height: 250px"
              placeholder="Tulis nama pegawai, format: [TimNama] Nama Pegawai"
              readonly
            >[Tim 1] Dr. Budi Santoso
[Tim 1] Suster Siti Aminah
[Tim 2] Perawat Joko
Admin Rina</textarea>
          </div>

          <div
            class="form-group"
            style="border-top: 1px solid #cbd5e1; padding-top: 15px"
          >
            <label>Tambah Pegawai Baru</label>
            <input type="text" id="newNama" placeholder="Ketik nama pegawai baru" />
            <select id="newTim" style="margin-top: 5px">
              <option value="">-- Pilih Tim (Opsional) --</option>
              <option value="Tim 1">Tim 1</option>
              <option value="Tim 2">Tim 2</option>
              <option value="Tim 3">Tim 3</option>
              <option value="Tim 4">Tim 4</option>
              <option value="Tim 5">Tim 5</option>
            </select>
            <button
              class="btn btn-primary"
              style="margin-top: 10px"
              onclick="App.tambahPegawai()"
            >
              <i class="fa fa-plus"></i> Tambah Pegawai
            </button>
          </div>

          <small style="color: #666; font-size: 11px; display: block; margin-top: 10px">
            *Klik nama di preview untuk hapus baris.
          </small>
        </div>

        <div id="tab-ttd" class="tab-panel">
          <div class="form-group">
            <label>Kiri (Mengetahui)</label>
            <input
              type="text"
              id="ttd1_jabatan"
              placeholder="Jabatan (mis: Direktur)"
              class="mb-1"
              oninput="App.render()"
            />
            <input
              type="text"
              id="ttd1_nama"
              placeholder="Nama Pejabat"
              style="margin-top: 5px"
              oninput="App.render()"
            />
            <input
              type="text"
              id="ttd1_nip"
              placeholder="NIP"
              style="margin-top: 5px"
              oninput="App.render()"
            />
          </div>
          <hr />
          <div class="form-group">
            <label>Kanan (Pembuat/Ka. Ruang)</label>
            <input
              type="text"
              id="ttd2_jabatan"
              placeholder="Jabatan"
              oninput="App.render()"
            />
            <input
              type="text"
              id="ttd2_kota"
              placeholder="Kota (mis: Jakarta)"
              style="margin-top: 5px"
              oninput="App.render()"
            />
            <input
              type="text"
              id="ttd2_nama"
              placeholder="Nama Pegawai"
              style="margin-top: 5px"
              oninput="App.render()"
            />
            <input
              type="text"
              id="ttd2_nip"
              placeholder="NIP"
              style="margin-top: 5px"
              oninput="App.render()"
            />
          </div>
        </div>
      </div>
    </aside>

    <main class="main-area">
      <div class="paper">
        <div class="header-section">
          <img id="viewLogo" src="" class="logo-img" />
          <div class="header-text">
            <h1 id="viewJudulInstansi">
              RUMAH SAKIT UMUM PENYANGGA PERBATASAN BETUN
            </h1>
            <h3 id="viewSubJudul"></h3>
          </div>
        </div>
        <table id="mainTable"></table>
      </div>
    </main>

    <div id="statsModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-header">
          <span>Rekapitulasi Absensi</span>
          <button
            class="close-btn"
            onclick="document.getElementById('statsModal').style.display='none'"
          >
            &times;
          </button>
        </div>
        <div class="modal-content">
          <table class="stat-table" id="statTableContent"></table>
        </div>
        <button
          class="btn btn-primary"
          style="margin-top: 15px"
          onclick="document.getElementById('statsModal').style.display='none'"
        >
          Tutup
        </button>
      </div>
    </div>

    <script>
      const App = {
        data: { attendance: {} },
        months: [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ],
        timMap: {},

        init() {
          const sel = document.getElementById("bulan");
          this.months.forEach((m, i) => sel.add(new Option(m, i)));
          const now = new Date();
          sel.value = now.getMonth();
          document.getElementById("tahun").value = now.getFullYear();
          this.loadState();
          this.render();
        },

        switchTab(tabId) {
          document.querySelectorAll(".tab-panel").forEach((el) => el.classList.remove("active"));
          document.querySelectorAll(".tab-btn").forEach((el) => el.classList.remove("active"));
          document.getElementById(tabId).classList.add("active");
          document.getElementById("btn-" + tabId).classList.add("active");
        },

        handleLogoUpload(input) {
          if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              document.getElementById("logoUrl").value = e.target.result;
              this.render();
            };
            reader.readAsDataURL(input.files[0]);
          }
        },

        updateColor() {
          const c = document.getElementById("headerColor").value;
          document.documentElement.style.setProperty("--table-header-bg", c);
          this.saveState();
        },

        getDaysArray() {
          const mIdx = parseInt(document.getElementById("bulan").value);
          const year = parseInt(document.getElementById("tahun").value);
          const daysInMonth = new Date(year, mIdx + 1, 0).getDate();
          const liburVal = document.getElementById("libur").value || "";
          const manualHolidays = liburVal.split(",").map((n) => parseInt(n.trim()));
          const sabtuLibur = document.getElementById("sabtuLibur").checked;

          let days = [];
          for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, mIdx, d);
            const dayNum = dateObj.getDay();
            const isHol = manualHolidays.includes(d) || dayNum === 0 || (sabtuLibur && dayNum === 6);
            let isToday = false; // nonaktif highlight today
            days.push({ d, isHol, isToday });
          }
          return days;
        },

        tambahPegawai() {
          const newNama = document.getElementById("newNama").value.trim();
          if (!newNama) {
            alert("Nama pegawai baru harus diisi!");
            return;
          }
          const newTim = document.getElementById("newTim").value.trim();
          let listNama = document.getElementById("listNama").value.trim();
          if (listNama) listNama += "\n";
          if (newTim) {
            listNama += `[${newTim}] ${newNama}`;
          } else {
            listNama += newNama;
          }
          document.getElementById("listNama").value = listNama;
          document.getElementById("newNama").value = "";
          document.getElementById("newTim").value = "";
          this.render();
        },

        render() {
          this.saveState();

          const judulLaporan = document.getElementById("judulLaporan").value;
          const mIdx = parseInt(document.getElementById("bulan").value);
          const year = parseInt(document.getElementById("tahun").value);
          const namesRaw = document.getElementById("listNama")
            .value.split("\n")
            .filter((n) => n.trim());

          const modeTim = document.getElementById("modeTim").checked;
          const showShift = document.getElementById("toggleShift").checked;

          // Parse tim dan nama
          this.timMap = {};
          let names = [];
          namesRaw.forEach((line, idx) => {
            let match = line.match(/^\s*\[(.+?)\]\s*(.+)$/);
            if (match) {
              this.timMap[idx] = match[1];
              names.push(match[2]);
            } else {
              this.timMap[idx] = null;
              names.push(line.trim());
            }
          });

          // Grouping by tim for modeTim
          let groupedData = [];
          if (modeTim) {
            let mapTim = {};
            names.forEach((name, i) => {
              let t = this.timMap[i] || "__--NO-TIM--__";
              if (!mapTim[t]) mapTim[t] = [];
              mapTim[t].push({ idx: i, name });
            });
            groupedData = Object.entries(mapTim).map(([tim, members]) => ({
              tim: tim === "__--NO-TIM--__" ? null : tim,
              members,
            }));
          } else {
            groupedData = [{ tim: null, members: names.map((name, i) => ({ idx: i, name })) }];
          }

          const logo =
            document.getElementById("logoUrl").value ||
            "https://cdn-icons-png.flaticon.com/512/9386/9386918.png";
          const daysData = this.getDaysArray();

          document.getElementById("viewJudulInstansi").innerText =
            "RUMAH SAKIT UMUM PENYANGGA PERBATASAN BETUN";
          document.getElementById(
            "viewSubJudul"
          ).innerText = `${judulLaporan} - BULAN ${this.months[mIdx]} ${year}`;
          document.getElementById("viewLogo").src = logo;

          // Header table
          let html = `<thead><tr>
        <th class="col-no" rowspan="2">NO</th>
        <th class="col-nama" rowspan="2" style="text-align:center;">NAMA PEGAWAI</th>
        <th colspan="${daysData.length}">TANGGAL</th>
      </tr><tr>`;
          daysData.forEach((day) => {
            const cls = day.isHol ? "st-libur" : "";
            html += `<th class="${cls}" style="width:24px;">${day.d}</th>`;
          });
          html += `</tr></thead><tbody>`;

          let rowsConfig = [];
          if (modeTim) {
            if (showShift) rowsConfig = [{ lbl: "Shift", key: "shift" }];
          } else {
            rowsConfig = [
              ...(showShift ? [{ lbl: "Shift", key: "shift" }] : []),
              { lbl: "Datang", key: "in" },
              { lbl: "Paraf", key: "sign_in" },
              { lbl: "Pulang", key: "out" },
              { lbl: "Paraf", key: "sign_out" },
            ];
          }

          let anggotaNo = 1;
          groupedData.forEach((group) => {
            if (modeTim && group.tim !== null) {
              // baris header shift tim
              html += `<tr><td colspan="${2 + daysData.length}" style="font-weight:bold; background:#eef2ff; font-size:0.9rem; text-align:left; padding-left:8px;">
                Shift <span style="font-weight:bold;">(${group.tim})</span>
              </td></tr>`;
            }

            group.members.forEach(({ idx, name }) => {
              html += `<tr>
              <td rowspan="${rowsConfig.length + 1}" style="font-weight:bold; border-bottom:2px solid #000;">${anggotaNo++}</td>
              <td colspan="${daysData.length + 1}" class="col-nama" title="Klik untuk hapus baris ini" onclick="App.clearRow(${idx})" style="border-bottom:none;">${name}</td>
            </tr>`;

              rowsConfig.forEach((cfg, rIdx) => {
                let borderStyle = rIdx === rowsConfig.length - 1 ? "border-bottom:2px solid #000;" : "";
                html += `<tr style="${borderStyle}"><td class="col-ket">${cfg.lbl}</td>`;

                daysData.forEach((day) => {
                  const bgClass = day.isHol ? "st-libur" : "";
                  let val = "";

                  if (modeTim && cfg.key === "shift") {
                    const timName = this.timMap[idx];
                    if (timName) {
                      const firstIdx = Object.entries(this.timMap).find(([i, t]) => t === timName);
                      if (firstIdx) {
                        val = this.data.attendance[`${firstIdx[0]}-${day.d}-shift`] || "";
                      }
                    } else {
                      val = this.data.attendance[`${idx}-${day.d}-shift`] || "";
                    }
                  } else if (!modeTim) {
                    val = this.data.attendance[`${idx}-${day.d}-${cfg.key}`] || "";
                  }

                  let clickAttr = "";
                  let textClass = "";
                  if (cfg.key === "shift" && showShift) {
                    clickAttr = `onclick="App.cycleShiftTeam(${idx}, '${this.timMap[idx]}', ${day.d}, this)"`;
                    textClass = "cell-input";
                  }

                  html += `<td class="${bgClass} ${textClass}" ${clickAttr}>${val}</td>`;
                });

                html += `</tr>`;
              });
            });
          });

          html += this.getTTDHTML(year, mIdx, daysData.length, 2 + daysData.length);
          html += `</tbody>`;

          document.getElementById("mainTable").innerHTML = html;
        },

        cycleShiftTeam(idx, timName, day, el) {
          const cycles = ["", "P", "S", "M", "L"];
          let currVal = el.innerText;
          let currIdx = cycles.indexOf(currVal);
          if (currIdx === -1) currIdx = 0;
          let nextVal = cycles[(currIdx + 1) % cycles.length];

          if (timName) {
            for (let [i, t] of Object.entries(App.timMap)) {
              if (t === timName) {
                App.data.attendance[`${i}-${day}-shift`] = nextVal;
              }
            }
          } else {
            App.data.attendance[`${idx}-${day}-shift`] = nextVal;
          }
          App.saveState();
          App.render();
        },

        clearRow(idx) {
          if (confirm(`Hapus semua data absensi untuk baris pegawai ke-${idx + 1}?`)) {
            const prefix = `${idx}-`;
            Object.keys(this.data.attendance).forEach((k) => {
              if (k.startsWith(prefix)) delete this.data.attendance[k];
            });
            this.render();
          }
        },

        getTTDHTML(year, mIdx, daysCount, colspan) {
          const fields = [
            "ttd1_jabatan",
            "ttd1_nama",
            "ttd1_nip",
            "ttd2_jabatan",
            "ttd2_kota",
            "ttd2_nama",
            "ttd2_nip",
          ];
          const v = {};
          fields.forEach((f) => (v[f] = document.getElementById(f).value || ".................."));
          return `
          <tr class="signature-row">
            <td colspan="${colspan}">
              <div class="footer-ttd">
                <div class="ttd-block">
                  <p>Mengetahui,<br>${v.ttd1_jabatan}</p>
                  <div class="ttd-space"></div>
                  <p><u><b>${v.ttd1_nama}</b></u><br>NIP. ${v.ttd1_nip}</p>
                </div>
                <div class="ttd-block">
                  <p>${v.ttd2_kota}, ${daysCount} ${this.months[mIdx]} ${year}<br>${v.ttd2_jabatan}</p>
                  <div class="ttd-space"></div>
                  <p><u><b>${v.ttd2_nama}</b></u><br>NIP. ${v.ttd2_nip}</p>
                </div>
              </div>
            </td>
          </tr>`;
        },

        saveState() {
          const state = {
            attendance: this.data.attendance,
            inputs: {
              judulLaporan: document.getElementById("judulLaporan").value,
              bulan: document.getElementById("bulan").value,
              tahun: document.getElementById("tahun").value,
              toggleShift: document.getElementById("toggleShift").checked,
              modeTim: document.getElementById("modeTim").checked,
              sabtuLibur: document.getElementById("sabtuLibur").checked,
              libur: document.getElementById("libur").value,
              listNama: document.getElementById("listNama").value,
              headerColor: document.getElementById("headerColor").value,
              logoUrl: document.getElementById("logoUrl").value,
              ttd1_jabatan: document.getElementById("ttd1_jabatan").value,
              ttd1_nama: document.getElementById("ttd1_nama").value,
              ttd1_nip: document.getElementById("ttd1_nip").value,
              ttd2_jabatan: document.getElementById("ttd2_jabatan").value,
              ttd2_kota: document.getElementById("ttd2_kota").value,
              ttd2_nama: document.getElementById("ttd2_nama").value,
              ttd2_nip: document.getElementById("ttd2_nip").value,
            },
          };
          localStorage.setItem("absenProData", JSON.stringify(state));
        },

        loadState() {
          const saved = localStorage.getItem("absenProData");
          if (saved) {
            try {
              const state = JSON.parse(saved);
              this.data.attendance = state.attendance || {};
              if (state.inputs) {
                for (const [k, v] of Object.entries(state.inputs)) {
                  const el = document.getElementById(k);
                  if (el) {
                    if (el.type === "checkbox") el.checked = v;
                    else el.value = v;
                  }
                }
                this.timMap = {}; // reset timMap, nanti akan diisi ulang di render
                document.documentElement.style.setProperty("--table-header-bg", state.inputs.headerColor);
              }
            } catch (e) {
              console.error("Load state error", e);
            }
          }
        },

        showStats() {
          const namesRaw = document.getElementById("listNama").value.split("\n").filter((n) => n.trim());
          const modeTim = document.getElementById("modeTim").checked;
          const daysData = this.getDaysArray();
          const names = [];
          const timMap = {};
          namesRaw.forEach((line, idx) => {
            let match = line.match(/^\s*\[(.+?)\]\s*(.+)$/);
            if (match) {
              timMap[idx] = match[1];
              names.push(match[2]);
            } else {
              timMap[idx] = null;
              names.push(line.trim());
            }
          });
          let html = `<thead><tr><th>Nama Pegawai</th>`;
          let cols = ["P", "S", "M", "L"];
          cols.forEach((c) => (html += `<th>${c}</th>`));
          html += `<th>Total</th></tr></thead><tbody>`;

          names.forEach((name, idx) => {
            let counts = {};
            cols.forEach((c) => (counts[c] = 0));
            let total = 0;
            daysData.forEach((day) => {
              let keys = [];
              if (modeTim) {
                let t = timMap[idx];
                if (t) {
                  let firstIdx = Object.entries(timMap).find(([i, x]) => x === t);
                  if (firstIdx) {
                    keys.push(`${firstIdx[0]}-${day.d}-shift`);
                  }
                } else {
                  keys.push(`${idx}-${day.d}-shift`);
                }
              } else {
                keys.push(`${idx}-${day.d}-shift`);
              }
              keys.forEach((k) => {
                let val = this.data.attendance[k];
                if (val && counts[val] !== undefined) {
                  counts[val]++;
                  total++;
                }
              });
            });
            html += `<tr><td style="text-align:left; font-weight:bold;">${name}</td>`;
            cols.forEach((c) => (html += `<td>${counts[c]}</td>`));
            html += `<td>${total}</td></tr>`;
          });
          html += `</tbody>`;
          document.getElementById("statTableContent").innerHTML = html;
          document.getElementById("statsModal").style.display = "flex";
        },

        downloadExcel() {
          const table = document.getElementById("mainTable");
          const wb = XLSX.utils.table_to_book(table, { sheet: "Absensi" });
          const bulan = document.getElementById("bulan").options[document.getElementById("bulan").selectedIndex].text;
          const tahun = document.getElementById("tahun").value;
          XLSX.writeFile(wb, `Absensi_${bulan}_${tahun}.xlsx`);
        },

        resetData() {
          if (confirm("Apakah Anda yakin ingin mereset SEMUA data dan pengaturan?")) {
            localStorage.removeItem("absenProData");
            location.reload();
          }
        },
      };

      window.onload = () => App.init();
    </script>
  </body>
</html>
